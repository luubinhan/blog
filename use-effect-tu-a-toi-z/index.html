<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>useEffect từ a tới z - VuiLapTrinh.com</title><meta name="gridsome:hash" content="bb9d7e5a46c25f220b2fd3c7f9d26cdf170dba2b"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.21"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Tutorials, Blog, Hướng dẫn, chia sẽ kinh nghiệm về Frontend, react, vue, ux, ui"><meta data-vue-tag="ssr" name="desc" content="Đây là một bài viết tương đối dài dòng về useEffect, bạn cần biết và đã đọc qua tài liệu về useEffect trên trang chính thức của React trước, và nếu chỉ thực sự cần biết sử dụng useEffect ra sao, bạn không cần đọc bài viết phân tách mổ xẻ sâu kiểu này."><link rel="preload" href="/blog/assets/css/0.styles.6e7bce94.css" as="style"><link rel="preload" href="/blog/assets/js/app.dd109642.js" as="script"><link rel="preload" href="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" as="script"><link rel="prefetch" href="/blog/assets/js/page--node-modules-gridsome-app-pages-404-vue.b044eecd.js"><link rel="prefetch" href="/blog/assets/js/page--src-pages-index-vue.bd4a2964.js"><link rel="prefetch" href="/blog/assets/js/page--src-templates-tag-vue.4999789e.js"><link rel="stylesheet" href="/blog/assets/css/0.styles.6e7bce94.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/blog/" class="logo active"><span class="logo__text">
    ← VuiLapTrinh.com
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">useEffect từ a tới z</h1><div class="post-meta">
  Đăng ngày 2020-03-23.
  
    Mất khoảng
    <strong>11 phút</strong> để đọc.
  </div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><!-- TOC -->
<ul>
<li><a href="#m%E1%BB%97i-l%E1%BA%A7n-render-l%C3%A0-m%E1%BB%99t-gi%C3%A1-tr%E1%BB%8B-prop-v%C3%A0-state-%C4%91%E1%BB%99c-l%E1%BA%ADp">Mỗi lần render là một giá trị Prop và State độc lập</a></li>
<li><a href="#m%E1%BB%99t-l%C3%A0-kh%C3%B4ng-n%C3%B3i-l%C3%A1o-2-l%C3%A0-kh%C3%B4ng-n%C3%B3i-l%C3%A1o-nhi%E1%BB%81u-l%E1%BA%A7n">Một là không nói láo, 2 là không nói láo nhiều lần</a></li>
<li><a href="#h%E1%BA%ADu-qu%E1%BA%A3-c%E1%BB%A7a-vi%E1%BB%87c-d%E1%BB%91i-tr%C3%A1">Hậu quả của việc dối trá</a></li>
<li><a href="#2-c%C3%A1ch-%C4%91%E1%BB%83-th%C3%BA-th%E1%BA%ADt-v%E1%BB%9Bi-react-v%E1%BB%81-dependency">2 cách để thú thật với React về dependency</a></li>
<li><a href="#t%C3%ADnh-n%C4%83ng-update-c%E1%BB%A7a-google-docs">Tính năng update của Google Docs</a></li>
</ul>
<!-- /TOC -->
<h2 id="mỗi-lần-render-là-một-giá-trị-prop-và-state-độc-lập"><a href="#m%E1%BB%97i-l%E1%BA%A7n-render-l%C3%A0-m%E1%BB%99t-gi%C3%A1-tr%E1%BB%8B-prop-v%C3%A0-state-%C4%91%E1%BB%99c-l%E1%BA%ADp" aria-hidden="true"><span class="icon icon-link"></span></a>Mỗi lần render là một giá trị Prop và State độc lập</h2>
<p>Trước khi bắt đầu nói về <code class="language-text">useEffect</code> chúng ta cần nhắc lại quá trình render</p>
<pre class="language-jsx{6}"><code class="language-jsx{6}">function Counter() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>You clicked {count} times</p> ...
      <button onClick={() => setCount(count + 1)}></button>
    </div>
  );
}</code></pre>
<p>Khác với Vue, nó không phải là một dạng <em>data binding</em>, <em>watcher</em>, <em>proxy</em>, nó chỉ là một giá trị thông thường.</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre>
<p>Đầu tiên giá trị khởi tạo của <code class="language-text">count</code> sẽ =0. Khi chúng ta gọi <code class="language-text">setCount(1)</code>, React sẽ gọi lại component một lần nữa, với giá trị <code class="language-text">count</code> lúc này là <code class="language-text">1</code>. Cứ vậy</p>
<pre class="language-jsx{3,10,17}"><code class="language-jsx{3,10,17}">// Lần đầu render
function Counter() {
  const count = 0; // trả về bởi useState()  // ...
  <p>You clicked {count} times</p>;
  // ...
}

// sau khi click, function này được gọi lại lần nữa
function Counter() {
  const count = 1; // trả về bởi `useState()  // ...
  <p>You clicked {count} times</p>;
  // ...
}

// sau khi click, function được gọi lại lần nữa
function Counter() {
  const count = 2; // trả về bởi useState()  // ...
  <p>You clicked {count} times</p>;
  // ...
}</code></pre>
<p>Khi update một state, React gọi lại component, mỗi lần render như vậy, nó sẽ <strong>thấy</strong> một giá trị <code class="language-text">count</code> mới. Sau đó React sẽ update lại DOM tương ứng.</p>
<p>Vấn đề mấu chốt cần nắm là giá trị <code class="language-text">count</code> <strong>trong các lần render khác nhau là khác nhau.</strong></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleAlertClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked on: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click me</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleAlertClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Show alert</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Chúng ta thực hiện các bước sau</p>
<ul>
<li>Bấm counter lên 3</li>
<li>Bấm "Show alert"</li>
<li>Bấm tiếp <code class="language-text">Click me</code> cho counter lên 5 trước khi bị gọi timeout</li>
</ul>
<p><img src="https://overreacted.io/46c55d5f1f749462b7a173f1e748e41e/counter.gif" alt="Counter demo"></p>
<p>Câu hỏi ở đây là nó sẽ alert ra 5 - giá trị cuối cùng, hay là 3 giá trị lúc chúng ta click</p>
<p><a href="https://codesandbox.io/s/w2wxl3yo0l" target="_blank" rel="nofollow noopener noreferrer">Chạy thử</a></p>
<p><em>Bạn có thấy kết quả quá vô lý?</em></p>
<p>Như đã nói ở trên, giá trị <code class="language-text">count</code> là hằng số trên mỗi lần render. <strong>Function của chúng ta được gọi nhiều lần, mỗi lần gọi như vậy giá trị <code class="language-text">count</code> bên trong là một số độc lập hoàn toàn với giá trị trước đó</strong></p>
<p>Không phải <strong>đặc sản</strong> của React, viết dạng function như thế này bạn sẽ dễ hình dung hơn.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token parameter">person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> someone <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Dan"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span>someone<span class="token punctuation">)</span><span class="token punctuation">;</span>

someone <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Yuzhi"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span>someone<span class="token punctuation">)</span><span class="token punctuation">;</span>

someone <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Dominic"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span>someone<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Thế còn hàm xử lý event thì sao? cụ thể là hàm <code class="language-text">handleAlertClick</code>? Cũng như trên, hàm này là có các <strong>version</strong> khác nhau ở các lần render khác nhau.</p>
<p>Bài viết được <strong>quảng cáo</strong> là nói về <code class="language-text">useEffect</code> mà nãy giờ chưa đá động gì!</p>
<p>Quay lại với ví dụ từ <a href="https://reactjs.org/docs/hooks-effect.html" target="_blank" rel="nofollow noopener noreferrer">trang chính thức của React</a></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">You clicked </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> times</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click me</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Câu hỏi là <code class="language-text">useEffect</code> đã làm cách nào để lấy được giá trị cuối cùng của <code class="language-text">count</code>?</p>
<p>Lẽ nào đó có một dạng "data binding" hay "watching" ở đây để update giá trị <code class="language-text">count</code> bên trong hàm effect? Hoặc giả React <em>chơi chiêu</em> dùng biến mutable bên trong component để luôn có được giá trị cuối?</p>
<p><em>Không hề!</em></p>
<p>Chúng ta đã biết: giá trị <code class="language-text">count</code> là hằng số cho các lần render, event handle cũng độc lập trên các lần render khác nhau, effect cũng vậy luôn.</p>
<p>Không phải giá trị <code class="language-text">count</code> thay đổi bên trong <code class="language-text">useEffect</code> <strong>bất biến</strong>, mà là <code class="language-text">useEffect</code> cũng bị thay đổi trên từng lần render.</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token comment">// lần render đầu tiên</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// sau khi click</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// click thêm lần nữa</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ..</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>Có thể mường tượng effect là một phần của kết quả lúc render</p>
</blockquote>
<p>Giờ thử với <code class="language-text">setTimeout</code></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>
    <span class="token method function property-access">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token spread operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">You clicked </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> times</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        Click me
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Nếu mà click vài lần với một khoảng thời gian <em>bỏ nhỏ</em> thì kết quả log ra là gì?</p>
<p><a href="https://codesandbox.io/s/lyx20m1ol" target="_blank" rel="nofollow noopener noreferrer">Thử ở đây</a></p>
<p>Bạn không chỉ nhận được 1 mà là một chuỗi các đoạn log ứng với số lần click.</p>
<p><img src="https://overreacted.io/a5727d333c270e05942f508707265378/timeout_counter.gif" alt="Screen recording of 1, 2, 3, 4, 5 logged in order"></p>
<p><em>Đương nhiên phải chạy như vậy mới đúng chứ, đâu có gì phải thắc mắc?</em></p>
<p>Bạn đã thử với <code class="language-text">this.state</code> trong class component chưa?</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><img src="https://overreacted.io/264b329edc111a1973003bdf2bcacd65/timeout_counter_class.gif" alt="Screen recording of 5, 5, 5, 5, 5 logged in order"></p>
<p><em>Lý do?</em> Giá trị <code class="language-text">this.state</code> bên trong class component là một mutation (có thể thay đổi).</p>
<p>Nếu luôn muốn lấy giá trị sau cùng bên trong effect, cách dễ nhất là dùng <code class="language-text">refs</code></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Example</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token spread operator">...</span>
    <span class="token keyword">const</span> latestCount <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token spread operator">...</span>

    <span class="token method function property-access">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token spread operator">...</span>
        latestCount<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token spread operator">...</span>
        <span class="token method function property-access">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
            <span class="token spread operator">...</span>
                <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>latestCount<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token spread operator">...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><img src="https://overreacted.io/timeout_counter_refs-78f7948263dd13b023498b23cb99f4fc.gif"></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Greeting</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello, </span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Nếu chúng ta render <code class="language-text">&lt;Greeting name=&quot;Dan&quot; /&gt;</code>, sau đó render <code class="language-text">&lt;Greeting name=&quot;Luu&quot; /&gt;</code>. Cuối cùng chúng ta luôn nhận được <em>Hello, Luu</em></p>
<p>React luôn đồng bộ cục DOM với giá trị hiện tại của <code class="language-text">prop</code> và <code class="language-text">state</code>. Không cần phân biệt giữa <code class="language-text">mount</code> và <code class="language-text">update</code> khi render. Có thể hình dung effect cũng tương tự như vậy, <strong><code class="language-text">useEffect</code> cho phép đồng bộ những phần không nằm trong React tree với giá trị của <code class="language-text">prop</code> và <code class="language-text">state</code></strong></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Greeting</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello, </span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Câu thần chú cho việc này là: <strong>Quan trọng là đích đến, không phải quá trình</strong></p>
<p>Chạy effect trên tất cả lúc chạy render sẽ không hay lắm, đôi khi có trường hợp lặp vô tận.</p>
<p>Trong quá trình re-render, React chỉ cập nhập đúng phần DOM đã thay đổi.</p>
<p>Ví dụ như</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello, Dan</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></code></pre>
<p>Sang</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello, Luu</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></code></pre>
<p>React sẽ thấy 2 object</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> oldProps <span class="token operator">=</span> <span class="token punctuation">{</span> className<span class="token operator">:</span> <span class="token string">"Greeting"</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token string">"Hello, Dan"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span> className<span class="token operator">:</span> <span class="token string">"Greeting"</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token string">"Hello, Yuzhi"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Nó sẽ xác định được <code class="language-text">children</code> bị thay đổi và cần update, còn <code class="language-text">className</code> thì không, nó sẽ làm như sau</p>
<pre class="language-js"><code class="language-js">domNode<span class="token punctuation">.</span><span class="token property-access">innerText</span> <span class="token operator">=</span> <span class="token string">"Hello, Luu"</span><span class="token punctuation">;</span></code></pre>
<p>Chúng ta cũng muốn effect làm điều tương tự, khi re-render chỉ apply những update cần thiết</p>
<p>Ví dụ với component này</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Greeting</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>counter<span class="token punctuation">,</span> setCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      Hello, </span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setCounter</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code class="language-text">useEffect</code> không hề liên quan tới giá trị state <code class="language-text">counter</code>, gọi <code class="language-text">document.title</code> khi giá trị <code class="language-text">counter</code> thay đổi không phải là ý hay.</p>
<p>Đó là lý do tại sao chúng ta có thêm tham số <code class="language-text">dependency</code> (một mảng) khi dùng <code class="language-text">useEffect</code></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// deps</span></code></pre>
<p>Dịch ra ngôn ngữ con người là thế này: "Tao biết React mày không phân biệt được sự khác nhau bên trong function, nên tao hứa là tao chỉ dùng đến <code class="language-text">name</code> bên trong function này thôi, và chỉ giá trị <code class="language-text">name</code> này update thì mày hả gọi nó"</p>
<h2 id="một-là-không-nói-láo-2-là-không-nói-láo-nhiều-lần"><a href="#m%E1%BB%99t-l%C3%A0-kh%C3%B4ng-n%C3%B3i-l%C3%A1o-2-l%C3%A0-kh%C3%B4ng-n%C3%B3i-l%C3%A1o-nhi%E1%BB%81u-l%E1%BA%A7n" aria-hidden="true"><span class="icon icon-link"></span></a>Một là không nói láo, 2 là không nói láo nhiều lần</h2>
<p>Đừng bao giờ lừa gạt React bằng cách đưa dependency không đúng cho nó, hậu quả nhãn tiền. Hợp lý, nhưng nhiều lập trình viên quen sử dụng <code class="language-text">class</code> sẽ cố tình qua mặt</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">SearchResults</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// việc ntn được hôn? không phải lúc nào cũng đúng</span>
  <span class="token comment">// có cách viết tốt hơn</span>
<span class="token punctuation">}</span></code></pre>
<p>Bạn sẽ nghĩ là "Tao chỉ muốn chạy nó lúc mount thôi". Nếu chúng ta chỉ định một dependency, <strong>tất cả giá trị bên trong component sử dụng bởi effect phải được khai báo cụ thể</strong>. Bao gồm prop, state, function</p>
<p>Đôi khi mà làm như vậy nó phát sinh lỗi. Thí dụ như gọi fetch data liên tục hoặc socket được tạo không cần thiết. Cách giải quyets là <strong>không xóa chúng khỏi dependency</strong></p>
<p>Trước khi nói về cách giải quyết, chúng ta xem vấn đề ở đây là gì khi so sánh Dependency</p>
<h2 id="hậu-quả-của-việc-dối-trá"><a href="#h%E1%BA%ADu-qu%E1%BA%A3-c%E1%BB%A7a-vi%E1%BB%87c-d%E1%BB%91i-tr%C3%A1" aria-hidden="true"><span class="icon icon-link"></span></a>Hậu quả của việc dối trá</h2>
<p>Nếu mảng dependency chứa tất cả giá trị sử dụng trong <code class="language-text">useEffect</code>, React biết được khi nào thì re-run nó</p>
<pre class="language-js"><code class="language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><img src="https://overreacted.io/fae247cd068eedbd4b62ba50592d2b3d/deps-compare-correct.gif" alt="Diagram of effects replacing one another"></p>
<p>Nhưng nếu chúng ta chỉ định <code class="language-text">[]</code>, nó không re-run sau lần đầu tiên</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// thiếu name</span></code></pre>
<p><img src="https://overreacted.io/25f75db3f9f57ffe1426912093577445/deps-compare-wrong.gif" alt="Diagram of effects replacing one another">,</p>
<pre class="language-js"><code class="language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Sai: không được phép bỏ qua thằng name</span></code></pre>
<p>Rõ ràng là 2 thằng dependency không khác nhau, nên nó sẽ không chạy effect</p>
<p>Trong tình huống này, vấn đề khá là hiển nhiên, nhưng trực giác có thể đánh lừa bạn trong các tình huống khác, lấy ví dụ, chúng ta muốn giá trị <code class="language-text">counter</code> tăng đều sau mỗi giây. Với một class, trực giác sẽ mách bảo: "Set up cái interval một lần, rồi dứt tình vứt áo một lần", kiểu như <a href="https://codesandbox.io/s/n5mjzjy9kl" target="_blank" rel="nofollow noopener noreferrer">thế này</a>, khi chuyển qua dùng <code class="language-text">useEffect</code> bạn sẽ nghĩ đến dùng <code class="language-text">[]</code> cho mảng phụ thuộc "Tao chỉ muốn tình một đêm", đúng không?</p>
<pre class="language-jsx{9}"><code class="language-jsx{9}">function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const id = setInterval(() => {
      setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
  }, []);

  return <h1>{count}</h1>;
}</code></pre>
<p>Theo như lập luận rất hay gặp "danh sách phụ thuộc cho phép chúng ta chỉ định việc re-render effect khi nào", và ở đây ta chỉ muốn trigger nó một lần vì nó là interval, <em>nhưng tại sao lại có vấn đề ở đây?</em></p>
<p>Chúng ta đang muốn effect này chỉ chạy lần đầu tiên mà thôi, đưa vào dependencies là <code class="language-text">[]</code> có vẻ hợp lý, React sẽ bỏ qua hết những lần sau, nhưng chúng ta đang lừa dối React, vì bên trong chúng ta có sử dụng giá trị <code class="language-text">count</code>, chúng ta có giá trị phụ thuộc mà không khai báo. Thực tế <code class="language-text">setCount()</code> sẽ gọi liên tục sau 1 giây, chứ không dừng lại sau lần gọi đầu tiên.</p>
<p>Ở lần render đầu tiên, <code class="language-text">count</code> = 0, vì thế <code class="language-text">setCount(count + 1)</code> ở lần render đầu tiên nghĩa là <code class="language-text">setCount(0+1)</code>, nhưng vì không re-run effect thêm lần nào nữa, chúng ta cứ gọi mãi <code class="language-text">setCount(0+1)</code> ở những lần tiếp theo</p>
<pre class="language-jsx{8,11}"><code class="language-jsx{8,11}">// state = 0
function Counter() {
  // ...
  useEffect(
    // lần đầu
    () => {
      const id = setInterval(() => {
        setCount(0 + 1); // luôn là setCount(1)      }, 1000);
      return () => clearInterval(id);
    },
    [] // không re-run  );
  // ...
}

// state = 1
function Counter() {
  // ...
  useEffect(
    // không bao giờ chạy    () => {
      const id = setInterval(() => {
        setCount(1 + 1);
      }, 1000);
      return () => clearInterval(id);
    },
    []
  );
  // ...
}</code></pre>
<p>Những con bug như thế này sẽ rất rất khó để mò ra được, vì thế hãy luôn thành thật với React, khai báo hết dependency đang có.</p>
<p><img src="https://overreacted.io/29e53bd0c9b7d2ac70d3cd924886b030/interval-wrong.gif" alt="Diagram of stale interval closure"></p>
<h2 id="2-cách-để-thú-thật-với-react-về-dependency"><a href="#2-c%C3%A1ch-%C4%91%E1%BB%83-th%C3%BA-th%E1%BA%ADt-v%E1%BB%9Bi-react-v%E1%BB%81-dependency" aria-hidden="true"><span class="icon icon-link"></span></a>2 cách để thú thật với React về dependency</h2>
<p><em>Nên chọn cách một, cách 2 chỉ áp dụng khi cần thiết</em></p>
<p><strong>Cách 1: luôn là người trung thực, chính trực đạo đức hết mực, luôn khai báo đầy đủ thông tin bạn trai, bạn gái, ba má, chú bác nào bạn đang phụ thuộc cho cơ quan thuế</strong></p>
<pre class="language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">etCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Tuy nhiên thế này, khi giá trị <code class="language-text">count</code> thay đổi, cái interval của chúng ta sẽ bị xóa và đặt lại lần nữa sau những lần render, nó không phải là cái chúng ta mong muốn nó hoạt động như vậy</p>
<p><img src="https://overreacted.io/5734271ddfa94d2d65ac6160515e0069/interval-rightish.gif" alt="Diagram of interval that re-subscribes"></p>
<p><strong>Cách 2 là thay đổi tư duy, giảm bớt anh trai nuôi, em gái nuôi không cần thiết</strong></p>
<p>Chúng ta không nói xạo, chúng ta giảm bớt số lượng những thứ phụ thuộc cho việc re-run effect</p>
<p>Để làm được việc này, chúng ta phải hỏi bản thân: <strong>chúng ta dùng count để làm gì?</strong> Có vẻ như chúng ta chỉ dùng nó cho việc gọi hàm <code class="language-text">setCount</code>, chúng ta không thực sự cần giá trị <code class="language-text">count</code> nếu chúng ta biết được giá trị trước đó, trường hợp trên, chúng ta có thể không cần dùng đến giá trị <code class="language-text">count</code> mà dùng <em>previous state</em></p>
<pre class="language-jsx{3}"><code class="language-jsx{3}">useEffect(() => {
  const id = setInterval(() => {
    setCount(c => c + 1);
  }, 1000);
  return () => clearInterval(id);
}, []);</code></pre>
<p><img src="https://overreacted.io/f128ad20c28317ed27a3cb68197fc906/interval-right.gif" alt="Diagram of interval that works"></p>
<p><a href="https://codesandbox.io/s/q3181xz1pj" target="_blank" rel="nofollow noopener noreferrer">Chạy thử</a></p>
<h2 id="tính-năng-update-của-google-docs"><a href="#t%C3%ADnh-n%C4%83ng-update-c%E1%BB%A7a-google-docs" aria-hidden="true"><span class="icon icon-link"></span></a>Tính năng update của Google Docs</h2>
<p>Khi nói về effect, định hướng lập trình chúng ta là <strong>đồng bộ hóa</strong>, có một khái niệm khá thú vị khi thực hiện đồng bộ hóa là chúng ta thường không đồng bộ toàn bộ nội dung. Lấy ví dụ như Google Docs, nó không thực sự truyền tải <strong>cả trang</strong> lên phía server, làm như vậy hiệu năng sẽ rất tệ, cái nó làm là gửi đi một thông tin chứa cái mà user đang muốn thực hiện.</p>
<p><strong>Tốt nhất truyền đi thật ít thông tin từ effect (chỉ những thông tin cần thiết nhất) vào trong component</strong>. Hàm <code class="language-text">setCount(c =&gt; c + 1)</code> sẽ gửi đi ít thông tin hơn so với hàm <code class="language-text">setCount(count + 1)</code> đứng trên một khía cạnh nào đó vì nó không phụ thuộc giá trị hiện tại, <a href="https://reactjs.org/docs/thinking-in-react.html#step-3-identify-the-minimal-but-complete-representation-of-ui-state" target="_blank" rel="nofollow noopener noreferrer">sử dụng ít state nhất có thể</a> để đạt được kết quả là một trong các nguyên lý chính của đợt cập nhập React với effect</p>
<p>Tuy nhiên không phải lúc nào cuộc sống cũng đơn giản với bạn như vậy, nếu chúng ta muốn tính toán giá trị của state mới dựa trên một prop, 2 giá trị state phụ thuộc lẫn nhau, <code class="language-text">setState</code> là không đủ. Chúng ta có người chị em hàng xóm tên <code class="language-text">useReducer</code></p>
<pre class="language-jsx{6}"><code class="language-jsx{6}">function Counter({ step }) {
  const [count, dispatch] = useReducer(reducer, 0);

  function reducer(state, action) {
    if (action.type === "tick") {
      return state + step;
    } else {
      throw new Error();
    }
  }

  useEffect(() => {
    const id = setInterval(() => {
      dispatch({ type: "tick" });
    }, 1000);
    return () => clearInterval(id);
  }, [dispatch]);

  return <h1>{count}</h1>;
}</code></pre>
<p>Cách dùng <code class="language-text">useReducer</code> như vậy là một dạng <strong>cheat mode</strong> của hook, cho phép chúng ta bỏ qua các dependency <em>ngầm</em> khỏi effect, và chặn re-run không không cần thiết</p>
<p><a href="https://codesandbox.io/s/7ypm405o8q" target="_blank" rel="nofollow noopener noreferrer">Chạy thử</a></p>
<p>Bài viết này vẫn còn, và nếu bạn vẫn còn muốn đào sâu hơn nữa, có thể tìm đọc bài viết gốc của Dan</p>
<p><a href="https://overreacted.io/a-complete-guide-to-useeffect/" target="_blank" rel="nofollow noopener noreferrer">A Complete Guide to useEffect</a></p>
</div><div class="post__footer"><div class="post-tags"><a href="/blog/tag/react/" class="post-tags__link"><span>#</span> react
		</a><a href="/blog/tag/hoc-thuat/" class="post-tags__link"><span>#</span> hoc-thuat
		</a></div></div></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-52311ff214b737f722259e901102d6b3'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-52311ff214b737f722259e901102d6b3)' width='180' height='180' xlink:href='data:image/jpeg%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAABwEDBAUGCAAC/8QAMxAAAQMCAwcBBgYDAAAAAAAAAQIDEQAEBRIhBhMxQVFhcQciIzJCgbEIFDORodEWgsH/xAAZAQEBAQEBAQAAAAAAAAAAAAAEAwUGAAH/xAAhEQABBAMAAgMBAAAAAAAAAAABAAIDEQQSISJBBRNRMf/aAAwDAQACEQMRAD8A6Pr1fOalmvLyUAk6AnxS5VROUx4oR%2bvmPXNjZYbhti48DcKUt9LRIJAHsgkaxMmO1ByzxnG8PeQ/a3d5bOIIUVJdUOHMifvWjB8c6aMP2q0CfPbC/TW119SVz9YetmOMLYRfWWH3TaSA4pKVNrWOuhgH6UYtkNrsK2stFvYU65nbjesOpyrbnhPIjuKhPhSwDZw4qw5kU5ph6r%2blpCYFNOLKflV5o1JSXMkDlS5xy1qtDo4mfrWe2/xhWEbJ3t400%2b6oZWyGpkBRiTGoSNJj/tVbEXEN/VMyAC1iPUTaS2xjG3bO3IS3ay2HNJc1lR6xPDx3oa4g0RvVlQcSfhFRLrEF3V0LpSAh10layOMzw7eKl3jqLhxsxLaRw4610MUYiAa1ZMxMosrPugpJJ0nlwiiJ%2bH69eZ28NulfuX7R0LTOhygKB8yKxWLaWoC0BJKpgfL2rdfh8sV3G1F9iBTLNnalGbkFuEADzAVVMpwOO6/xCx4izJaAuiSsT8UV8KKyBznmKih1J714OqIiCa5jVdJsqk4ggL9oRPSqDbty4/w/GnLVzKPyypBkaEif4p5N2RwA/anlPtvsrafAW0tJStChKVA8QR0p4ZqQQil1ilz5Y5nGloXKkcNev908G8iUoSCUiiHtVhFhhdou6wu2O6JyuNg/pzwUCdY5a8JrAXtwErWi3RmIEZwZE9utaccm/QEVzKVZjVrltN4JyJMqFdGemuz7OzmyFjbBGS5eQLm6PMuLAMf6iE/SgBavuMPNOON75wKC0tr4GDPtdqO%2bxm0i8ew0O3O7RfJnett6J4mCnXhH81DNDzGK/i%2b4/wBbZSb7S1xQ2IIVBHWvb2BAIioBcVxMCml3KgYFZQZadtSzAK460hCpkk%2bBTzahmmnXnRA0APmadsj0ol1uE2T6r5SEWgbO9K%2bARGs0H7stto3luczSyS3mEKUJIBI66VrvUnGWlJZwlKsuaHnjmgafCk/f9qwD6y%2b2pbjhKU%2bylWaJ8dabjxmtne0HInolrVcYThj18w5clKzl1KOZ/sVLRtJ%2bQbQ7akpum/01oEA9c3bvULB8WtGbRYuW1vvBOVtTivm48eVUt9Z3dwpKlIbaZIhJQZEdJq7fJxDxxHcdWgxnvtFbZz1ItsQCWMWyWb8hJcn3ZV3Pyz14eK2e9WpUBJoGYHhVpmCQyCtTZBMaHz1oq7DYxvmBh11IeZT7pR%2bZA5eR9vFCyoGs8owm4sz38kK//9k=' /%3e%3c/svg%3e" width="180" data-src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" data-srcset="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" class="author__image g-image g-image--loaded" width="180" alt="Author image"></noscript><!----><p class="author__intro">Hiện tại site đang nâng cấp, các bạn xài tạm</p></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2020.</span><span class="footer__links">luckyluu</span></footer></div>
    <script src="/blog/assets/js/app.dd109642.js" defer></script><script src="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" defer></script>
  </body>
</html>