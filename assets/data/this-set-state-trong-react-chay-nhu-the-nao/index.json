{"hash":"e579e30389c3a92ccdc1669d7f43640a00bbbfb5","data":{"post":{"title":"this.setState trong React chạy như thế nào","path":"/this-set-state-trong-react-chay-nhu-the-nao/","slug":"/2018-12-12-setstate-chay-nhu-the-nao","date":"2018-12-12","timeToRead":3,"tags":[{"id":"react","title":"react","path":"/tag/react/"}],"desc":"Giải đáp thắc mắc vì sao this.setState có thể update DOM, chạy được trên mobile, chạy được trên bất kỳ môi trường nào","content":"<p>Update lại DOM nghe có vẻ là công việc của React DOM, tuy nhiên chúng ta gọi <code class=\"language-text\">this.setState()</code> bên trong một React Component,  nó sẽ không liên quan tới React DOM, React.Component sẽ xử lý.</p>\n<p>Vậy làm sao <code class=\"language-text\">setState()</code> bên trong React.Component update được DOM? Bạn có thể nghĩ là bên trong React.Component chứa logic để update DOM. Nhưng tại sao chúng ta vẫn có thể gọi <code class=\"language-text\">this.setState()</code> trên các môi trường khác, ví dụ như sử dụng trên React Native, nó cũng là extends của <code class=\"language-text\">React.Component</code>. Và React Native thì làm việc được trên cả Android iOS, cái View đó thì ko dựng bằng DOM.</p>\n<p>Nếu bạn đã sử dụng qua React Test Renderer hoặc Shallow Renderer. Cả 2 cách test này đều cho phép render một component bình thường và gọi <code class=\"language-text\">this.setState</code> bên trong nó. Và cả 2 thằng đó cũng ko liên quan gì tới DOM.</p>\n<p>Như vậy là <code class=\"language-text\">React.Component</code> được giao nhiệm vụ update state thì nó chạy một đoạn code chỉ định theo từng platform.</p>\n<p>Rất nhiều người lầm tưởng có một React <em>engine</em> bên trong package <code class=\"language-text\">react</code>. Điều này không đúng.</p>\n<p>Thực chất, kể từ phiên bản React 0.14, package <code class=\"language-text\">react</code> đã được tách hẳn ra cung cấp các API để khai báo <em>component</em>. Hầu hết code được thực hiện ở các <strong>renderers</strong></p>\n<p><code class=\"language-text\">react-dom</code>, <code class=\"language-text\">react-dom/server</code>, <code class=\"language-text\">react-native</code>, <code class=\"language-text\">react-test-renderer</code>, <code class=\"language-text\">react-art</code> là những <strong>renderers</strong> như vậy. Và bạn cũng có thể tự build một cái  luôn.</p>\n<p>Đó là lý do tại sao package <code class=\"language-text\">react</code> rất là hữu dụng dù bạn đang sử dụng trên bất kỳ platform nào. Tất cả những gì nó export, như <code class=\"language-text\">React.Component</code>, <code class=\"language-text\">React.createElement</code>, <code class=\"language-text\">React.Children</code> và thậm chí là <em>Hook</em>, độc lập hoàn toàn với platform. Và khi dùng chung với React DOM, React DOM server, React Native, các component của chúng ta vẫn import và sử dụng như nhau.</p>\n<p>Những thằng renderer sẽ có các API như <code class=\"language-text\">ReactDOM.render()</code> cho phép mount cấu trúc React Component vào DOM node. Mỗi thằng renderer sẽ cung cấp các API tương tự như vậy trên platform của nó. Tất cả các component khi được khai báo không cần import bất cứ gì từ renderer, như vậy để nó portable.\nBạn có thể hiểu là tại sao khi cập nhập thì chúng ta cần cập nhập cả 2 package <code class=\"language-text\">react</code> và <code class=\"language-text\">react-dom</code> cùng lúc. Ví dụ khi React 16.3 ra API context, <code class=\"language-text\">React.createContext()</code>, cái này <code class=\"language-text\">react</code> chưa có implement, mà được implement trong renderer như  React DOM, và React DOM Server sẽ có 2 cách implement khác nhau, React DOM có thể track context một chiều, nhưng React DOM Server sẽ track theo kiểu khác.</p>\n<p>Vẫn chưa trả lời được câu hỏi ban đầu, làm sao <code class=\"language-text\">setState()</code> bên trong <code class=\"language-text\">React.Component</code> <strong>nói chuyện</strong> với đúng renderer nó cần.</p>\n<p>Câu trả lời là các renderer set một field đặc biệt trong lúc create class. Field này gọi là <code class=\"language-text\">updater</code>, giá trị này bạn ko phải set, mà là công việc của React DOM, React DOM server, React Native set ngay sau khi tạo 1 instance của class.</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Bên trong React DOM</span>\n<span class=\"token keyword\">const</span> inst <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YourComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">props</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">updater</span> <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">ReactDOMUpdater</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Bên trong React DOM Server</span>\n<span class=\"token keyword\">const</span> inst <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YourComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">props</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">updater</span> <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">ReactDOMServerUpdater</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Bên trong React Native</span>\n<span class=\"token keyword\">const</span> inst <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YourComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">props</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\ninst<span class=\"token punctuation\">.</span><span class=\"token property-access\">updater</span> <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">ReactNativeUpdater</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Bên trong React, nó chỉ delegate lại công việc cho các renderer</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ví dụ đã được cắt bớt các phần khác.</span>\n<span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">partialState<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Sử dụng field `updater`</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">updater</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">enqueueSetState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> partialState<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Hy vọng bạn đã hiểu tại sao <code class=\"language-text\">this.setState()</code> có thể update được DOM</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://overreacted.io/how-does-setstate-know-what-to-do/\">How does setstate know what to do</a></p>\n","cover_image":"","related":[{"id":"d6fb0d32e4ef12d7a00ffb83684328e2","path":"/import-lodash-nhu-the-nao-moi-dung/","title":"Import lodash như thế nào mới đúng","desc":"Nếu cần xài lodash, thì bạn xài nó sao cho hiệu quả"},{"id":"dea079a7d56929f46cf5c0bdd1070ebf","path":"/redux-van-hanh-nhu-the-nao/","title":"Redux vận hành như thế nào","desc":"Actions, reducers, action creators, middleware, pure functions, immutability,... những ngoại ngữ làm rối bất kỳ ai nếu chưa biết redux"},{"id":"c7db4e8951472801d63827ce67e67fe7","path":"/micro-frontend-tai-sao-va-nhu-the-nao/","title":"Micro frontend tại sao và như thế nào","desc":"Lướt qua một vài điểm về Micro Frontend, ý tưởng chính và các vấn đề được quan tâm"},{"id":"5eadb4fb31a8a53f91d7af473359e9f1","path":"/function-component-khac-class-component-nhu-the-nao-trong-react/","title":"Function Component khác Class component như thế nào trong React","desc":"Ngày xưa khi chưa có hook, thì rất dễ để trả lời câu này, nhưng từ ngày hook được sử dụng, câu hỏi lại này lại được đặt ra, ủa vậy 2 thằng nó khác nhau ở điểm nào."}]}},"context":{}}