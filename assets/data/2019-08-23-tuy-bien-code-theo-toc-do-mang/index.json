{"hash":"96c8dea8aa6d6e6f9c0c563edfb92dcd7958f442","data":{"post":{"title":"Tùy biến code theo tốc độ mạng","path":"/2019-08-23-tuy-bien-code-theo-toc-do-mang/","slug":"/2019-08-23-tuy-bien-code-theo-toc-do-mang","date":"2019-08-23","timeToRead":2,"tags":[{"id":"javascript","title":"javascript","path":"/tag/javascript/"},{"id":"thu-thuat","title":"thu-thuat","path":"/tag/thu-thuat/"}],"desc":"Responsive với CSS chúng ta tùy biến code bằng @media, vậy với JS, ta thêm các điều kiện theo tốc độ mạng bằng cách nào?","content":"<p>Responsive với CSS chúng ta tùy biến code bằng @media, vậy với JS, ta thêm các điều kiện theo tốc độ mạng bằng cách nào?</p>\n<p>Chúng ta sẽ sử dụng API của trình duyệt <code class=\"language-inline-text\">navigator.connection.effectiveType</code> để tối ưu theo tốc độ kết nối mạng của user</p>\n<p>Các thông tin về mạng của user có thể lấy qua <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/connection\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">navigator.connection</a>, trong đó có giá trị <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/NetworkInformation/effectiveType\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">effectiveType</a> là một trong các giá trị 'slow-2g', '2g', '3g', '4g'</p>\n<p>Chrome 62 trở về trước, chúng ta chỉ có giá trị <code class=\"language-inline-text\">navigator.connection.type</code>, giá trị này không phải tốc độ mạng. Mặc dù <code class=\"language-inline-text\">type</code> là wifi, nhưng lại là một wifi cùi mía, tốc độ ngang ngửa 2g, Chrome sau này có <em>phát minh</em> thêm giá trị <code class=\"language-inline-text\">effectiveType</code>, tính theo tốc độ đi-về của cục dữ liệu cho chính xác.</p>\n<p><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--T54UF-7H--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/wqeuhx12frs3k126bmrv.png\" alt=\"Đáp ứng theo tốc độ mạng\"></p>\n<p>Còn trường hợp, trong nhà có thanh niên nào đó mở link down film Nhật, tốc độ mạng đang \"như tia chớp\", thì chuyển sang \"cùi mía\", biết được sự thay đổi này cần add thêm cái listener cho đối tượng <code class=\"language-inline-text\">navigator.connection</code></p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">onConnectionChange</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n        rtt<span class=\"token punctuation\">,</span>\n        downlink<span class=\"token punctuation\">,</span>\n        effectiveType<span class=\"token punctuation\">,</span>\n        saveData\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> navigator<span class=\"token punctuation\">.</span>connection\n\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Effective network connection type: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>effectiveType<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Downlink Speed/bandwidth estimate: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>downlink<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">Mb/s</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Round-trip time estimate: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rtt<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Data-saver mode on/requested: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>saveData<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nnavigator<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span> onConnectionChange<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dùng Chrome DevTools để giả lập các tốc độ mạng khác nhau để test, chứ đừng down film để test tốc độ</p>\n<p><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--gdIz0VyD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/t9zadl65erjhll14zbcp.png\" alt=\"Đáp ứng theo tốc độ mạng\"></p>\n<p>Mấy trình duyệt xịn xịn như Chrome, Opera, Firefox là dùng được <code class=\"language-inline-text\">navigator.connection</code> chứ không riêng gì Chrome</p>\n<p>Dùng một regex để gom mấy kết quả <em>gờ gờ</em> là mạng chậm hết, 3g Việt Nam thì cũng như 2g thôi</p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\slow-2g|2g|3g</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>navigator<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span>effectiveType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connection <span class=\"token operator\">=</span> <span class=\"token string\">\"slow\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connection <span class=\"token operator\">=</span> <span class=\"token string\">\"fast\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Mình sử dụng Vue.js, không phải HTML thuần nên đừng thắc mắc sao có cái <code class=\"language-inline-text\">v-if</code> nhé</p>\n<div class=\"gridsome-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>home<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">v-if</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>connection === 'fast'<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token comment\">&lt;!-- 1.3MB video --></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theatre<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">autoplay</span> <span class=\"token attr-name\">muted</span> <span class=\"token attr-name\">playsinline</span> <span class=\"token attr-name\">control</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>source</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/img/doodle-theatre.webm<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>video/webm<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>source</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/img/doodle-theatre.mp4<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>video/mp4<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>video</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token comment\">&lt;!-- 28KB image --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">v-if</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>connection === 'slow'<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theatre<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/img/doodle-theatre-poster.jpg<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--_tvmKtK---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8jukzhdu62nbghw0cfx3.png\" alt=\"Đáp ứng theo tốc độ mạng\"></p>\n<p>Nếu bạn viết React, có <a href=\"https://mxb.dev/blog/connection-aware-components/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bài này cũng hay</a>, nói về việc làm component đáp ứng theo tốc độ kết nối</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://dev.to/addyosmani/adaptive-serving-using-javascript-and-the-network-information-api-331p\">📜 Adaptive Serving using JavaScript and the Network Information API</a></p>\n","cover_image":"","related":[{"id":"d3d798db759372d505ddf2c1efbdf2e4","path":"/2018-11-15-them-v-model-cho-vue-component-tu-viet/","title":"Hỗ trợ v-model trên Vue component tùy biến","desc":"Hướng dẫn cách viết một component để có thể dùng v-model"},{"id":"5b62a4dd4557224e507cd92ffab74628","path":"/2021-09-06-gioi-thieu-proxy-cua-javascript/","title":"Giới thiệu Javascript Proxy object","desc":""},{"id":"691018d928912ef0c296b5f00948cd37","path":"/2022-02-02-babel-preset-env-core-js-browerslistrc-lam-viec/","title":"Cách mà babel preset-env, core-js, browserslistrc làm việc với nhau","desc":""}]}},"context":{}}