{"hash":"d690b1fe3b39613de73c79c53541f7a4a1780354","data":{"post":{"title":"Làm sao để fetch dữ liệu bằng React Hook","path":"/lam-sao-de-fetch-du-lieu-bang-react-hook/","date":"2019-11-18","timeToRead":11,"tags":[{"id":"hoc-thuat","title":"hoc-thuat","path":"/tag/hoc-thuat/"},{"id":"react","title":"react","path":"/tag/react/"}],"desc":"Trong bài này chúng ta sẽ sử dụng React.useState, React.useEffect, React.useReducer để fetch dữ liệu từ API, đồng thời cũng viết một custom hook để có thể sử dụng ở bất kỳ đâu","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#g%e1%bb%8di-hook-th%e1%bb%a7-c%c3%b4ngb%e1%ba%b1ng-code\">Gọi hook thủ công/bằng code</a></li>\n<li><a href=\"#loading-indicator\">Loading indicator</a></li>\n<li><a href=\"#handle-error\">Handle Error</a></li>\n<li><a href=\"#fetch-data-v%e1%bb%9bi-form\">Fetch data với Form</a></li>\n<li><a href=\"#custom-hook-%c4%91%e1%bb%83-fetch-data\">Custom hook để Fetch data</a></li>\n<li><a href=\"#reducer-hook\">Reducer hook</a></li>\n<li><a href=\"#b%e1%bb%8f-qua-vi%e1%bb%87c-fetch-data\">Bỏ qua việc fetch data</a></li>\n</ul>\n<!-- /TOC -->\n<p>Chúng ta có một component, dữ liệu của component này sẽ được lấy từ API</p>\n<pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword module\">import</span> <span class=\"token imports\"><span class=\"token maybe-class-name\">React</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useState <span class=\"token punctuation\">}</span></span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\"><span class=\"token maybe-class-name\">App</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> hits<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span><span class=\"token property-access\">hits</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">objectID</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">url</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">title</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword module\">export</span> <span class=\"token keyword module\">default</span> <span class=\"token maybe-class-name\">App</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Chúng ta sẽ sử dụng axios để fetch dữ liệu, bạn thích xài cái khác thì cứ vô tư</p>\n<pre class=\"language-jsx{7-12}\"><code class=\"language-jsx{7-12}\">import React, { useState, useEffect } from 'react';\nimport axios from 'axios';\n\nfunction App() {\n  const [data, setData] = useState({ hits: [] });\n  \n  useEffect(async () => {\n    const result = await axios(\n      'https://hn.algolia.com/api/v1/search?query=redux',\n    );\n    setData(result.data);\n  });\n\n  return (\n    <ul>\n      {data.hits.map(item => (\n        <li key={item.objectID}>\n          <a href={item.url}>{item.title}</a>\n        </li>\n      ))}\n    </ul>\n  );\n}\nexport default App;</code></pre>\n<p>Bên trong <code class=\"language-text\">React.useEffect</code> chúng ta sẽ thực hiện việc fetch data từ API, sau khi nhận được dữ liệu gán giá trị nhận được cho giá trị của state <code class=\"language-text\">data</code></p>\n<p>Nếu dừng ở đây, khi chạy bạn sẽ thấy một vòng lặp vô tận của việc gọi fetch data. Effect sẽ chạy không chỉ ở lúc component mount mà còn ở các lần update tiếp theo. Bởi vì chúng ta gán giá trị state trên mỗi lần fetch, component lại được update và effect lại được gọi lại để chạy. Chúng ta chỉ muốn <strong>fetch data khi component mount lần đầu tiên</strong>. Đó là lý do chúng ta phải thêm một mảng rỗng vào tham số thứ hai của effect, như vậy các lần update tiếp theo nó sẽ không được gọi.</p>\n<pre class=\"language-js{12}\"><code class=\"language-js{12}\">import React, { useState, useEffect } from 'react';\nimport axios from 'axios';\n\nfunction App() {\n  const [data, setData] = useState({ hits: [] });\n  \n  useEffect(async () => {\n    const result = await axios(\n      'https://hn.algolia.com/api/v1/search?query=redux',\n    );\n    setData(result.data);\n  }, []);\n  \n  return (\n    <ul>\n      {data.hits.map(item => (\n        <li key={item.objectID}>\n          <a href={item.url}>{item.title}</a>\n        </li>\n      ))}\n    </ul>\n  );\n}\nexport default App;</code></pre>\n<p>Tham số thứ 2 truyền vào cho effect này là danh sách những giá trị nào mà hook phụ thuộc, tức nếu các giá trị này thay đổi thì effect được gọi lại. Bỏ array trống sẽ không còn chuyện chạy ở lần update.</p>\n<p>Trong đoạn code trên vẫn còn một chỗ phải chỉnh sửa, chúng ta sử dụng <code class=\"language-text\">async/await</code>, <em>theo như định nghĩa</em>, tất cả những hàm nào là <code class=\"language-text\">async</code> sẽ được ngầm hiểu là trả về một <code class=\"language-text\">Promise</code>. Tuy nhiên, cũng <em>theo như định nghĩa</em> effect hook không được trả về gì cả, hoặc một function để clean up (xem lại bài nói về Hook Effect, có giải thích 2 loại Effect Hook).</p>\n<p>Nên bạn mà copy đoạn trên mà chạy thì sẽ nhận thông báo bên dưới console. Không thể sử dụng async function bên trong <code class=\"language-text\">React.useEffect</code>, chúng ta sửa lại</p>\n<pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'https://hn.algolia.com/api/v1/search?query=redux'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Để fetch dữ liệu bằng <code class=\"language-text\">React.useEffect</code> có thể tóm gọn như ở trên. Chúng ta sẽ tiếp tục xem cách handle error, loading indicator, gọi fetch từ form và làm thế nào tái sử dụng hook để fetch</p>\n<h2 id=\"gọi-hook-thủ-côngbằng-code\"><a href=\"#g%E1%BB%8Di-hook-th%E1%BB%A7-c%C3%B4ngb%E1%BA%B1ng-code\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Gọi hook thủ công/bằng code</h2>\n<p>Chúng ta đã xong phần fetch dữ liệu một lần lúc component mount. Nhưng làm thế nào để fetch dữ liệu khi có sự kiện từ user, ví dụ ô search, khi user nhập lấy danh sách kết quả tìm kiếm. Ví dụ bên dưới mặc định sẽ hiển thị kết quả cho từ khóa <code class=\"language-text\">redux</code>, nếu user nhập vào một giá trị khác, chúng ta cần làm sao để chạy <code class=\"language-text\">useEffect</code> một lần nữa</p>\n<pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword module\">import</span> <span class=\"token imports\"><span class=\"token maybe-class-name\">React</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token maybe-class-name\">Fragment</span><span class=\"token punctuation\">,</span> useState<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span></span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword module\">import</span> <span class=\"token imports\">axios</span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\"><span class=\"token maybe-class-name\">App</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">,</span> setData<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> hits<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>query<span class=\"token punctuation\">,</span> setQuery<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redux'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'https://hn.algolia.com/api/v1/search?query=redux'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span>\n        <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>query<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">event</span> <span class=\"token arrow operator\">=></span> <span class=\"token function\">setQuery</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span><span class=\"token property-access\">target</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span><span class=\"token property-access\">hits</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">objectID</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">url</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span><span class=\"token property-access\">title</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword module\">export</span> <span class=\"token keyword module\">default</span> <span class=\"token maybe-class-name\">App</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Với nhu cầu như trên, chúng ta cần cập nhập lại <code class=\"language-text\">useEffect</code></p>\n<pre class=\"language-js{4}\"><code class=\"language-js{4}\">useEffect(() => {\n  const fetchData = async () => {\n    const result = await axios(\n      `http://hn.algolia.com/api/v1/search?query=${query}`,\n    );\n    setData(result.data);\n  };\n  fetchData();\n}, []);</code></pre>\n<p>Tuy nhiên, nếu chỉ như vậy, hàm <code class=\"language-text\">fetchData</code> sẽ không được gọi khi user input một giá trị mới vào ô tìm kiếm. Vì chúng ta đã truyền vào một mảng rỗng vào cho giá trị <code class=\"language-text\">depend</code> của effect, nên nó chỉ chạy lần đầu mount</p>\n<pre class=\"language-js{9}\"><code class=\"language-js{9}\">useEffect(() => {\n  const fetchData = async () => {\n    const result = await axios(\n      `http://hn.algolia.com/api/v1/search?query=${query}`,\n    );\n    setData(result.data);\n  };\n  fetchData();\n}, [query]);</code></pre>\n<p>Có một vấn đề khác, user cứ nhập một ký tự, câu <code class=\"language-text\">fetchData</code> lại được gọi, gọi liên tục như vậy không hay, thêm vào một nút để user click vào mới thực hiện search thì sao</p>\n<pre class=\"language-jsx{4,23,24,25}\"><code class=\"language-jsx{4,23,24,25}\">function App() {\n  const [data, setData] = useState({ hits: [] });\n  const [query, setQuery] = useState('redux');\n  const [search, setSearch] = useState('');\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      const result = await axios(\n        `http://hn.algolia.com/api/v1/search?query=${query}`,\n      );\n      setData(result.data);\n    };\n    fetchData();\n  }, [query]);\n  \n  return (\n    <Fragment>\n      <input\n        type=\"text\"\n        value={query}\n        onChange={event => setQuery(event.target.value)}\n      />\n      <button type=\"button\" onClick={() => setSearch(query)}>\n        Search\n      </button>\n      <ul>\n        {data.hits.map(item => (\n          <li key={item.objectID}>\n            <a href={item.url}>{item.title}</a>\n          </li>\n        ))}\n      </ul>\n    </Fragment>\n  );\n}</code></pre>\n<p>Giờ effect phải phụ thuộc vào <code class=\"language-text\">search</code>, không chạy khi user nhập vào input</p>\n<pre class=\"language-js{4,9,14}\"><code class=\"language-js{4,9,14}\">function App() {\n  const [data, setData] = useState({ hits: [] });\n  const [query, setQuery] = useState('redux');\n  const [search, setSearch] = useState('redux');\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      const result = await axios(\n        `http://hn.algolia.com/api/v1/search?query=${search}`,\n      );\n      setData(result.data);\n    };\n    fetchData();\n  }, [search]);\n  \n  return (\n    ...\n  );\n}</code></pre>\n<p>Nhưng nếu sửa như vậy, trường hợp component được mount lần đầu, nó sẽ không có hiển thị kết quả cho từ khóa <code class=\"language-text\">redux</code> nữa. Nếu dùng thềm một <code class=\"language-text\">useEffect</code> khác cho trường hợp chạy lúc đầu sẽ gây nhầm lẫn, không rõ ràng, thay vào đó nếu chúng ta xem search state là nguyên cái <code class=\"language-text\">url</code> sẽ đơn giản hơn</p>\n<pre class=\"language-jsx{4,5,6,10,16,28}\"><code class=\"language-jsx{4,5,6,10,16,28}\">function App() {\n  const [data, setData] = useState({ hits: [] });\n  const [query, setQuery] = useState('redux');\n  const [url, setUrl] = useState(\n    'https://hn.algolia.com/api/v1/search?query=redux',\n  );\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      const result = await axios(url);\n      \n      setData(result.data);\n    };\n    \n    fetchData();\n  }, [url]);\n  \n  return (\n    <Fragment>\n      <input\n        type=\"text\"\n        value={query}\n        onChange={event => setQuery(event.target.value)}\n      />\n      <button\n        type=\"button\"\n        onClick={() =>\n          setUrl(`http://hn.algolia.com/api/v1/search?query=${query}`)\n        }\n      >\n        Search\n      </button>\n      <ul>\n        {data.hits.map(item => (\n          <li key={item.objectID}>\n            <a href={item.url}>{item.title}</a>\n          </li>\n        ))}\n      </ul>\n    </Fragment>\n  );\n}</code></pre>\n<h2 id=\"loading-indicator\"><a href=\"#loading-indicator\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Loading indicator</h2>\n<p>Một nhu cầu khác cũng hay gặp là trong lúc fetch data từ API, chúng ta cần biết trạng thái loading tới đâu rồi, chúng ta sẽ bổ sung thêm state <code class=\"language-text\">isLoading</code></p>\n<pre class=\"language-jsx{7,11,16}\"><code class=\"language-jsx{7,11,16}\">function App() {\n  const [data, setData] = useState({ hits: [] });\n  const [query, setQuery] = useState('redux');\n  const [url, setUrl] = useState(\n    'https://hn.algolia.com/api/v1/search?query=redux',\n  );\n  const [isLoading, setIsLoading] = useState(false);\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      setIsLoading(true);\n      \n      const result = await axios(url);\n      \n      setData(result.data);\n      setIsLoading(false);\n    };\n    fetchData();\n  }, [url]);\n  \n  return (\n    <Fragment>\n      <input\n        type=\"text\"\n        value={query}\n        onChange={event => setQuery(event.target.value)}\n      />\n      <button\n        type=\"button\"\n        onClick={() =>\n          setUrl(`http://hn.algolia.com/api/v1/search?query=${query}`)\n        }\n      >\n        Search\n      </button>\n      {isLoading ? (\n        <div>Loading ...</div>\n      ) : (\n        <ul>\n          {data.hits.map(item => (\n            <li key={item.objectID}>\n              <a href={item.url}>{item.title}</a>\n            </li>\n          ))}\n        </ul>\n      )}\n    </Fragment>\n  );\n}\nexport default App;</code></pre>\n<h2 id=\"handle-error\"><a href=\"#handle-error\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Handle Error</h2>\n<p>Cũng tương tự như loading, chúng ta sẽ bổ sung thêm state <code class=\"language-text\">isError</code> để xác định việc fetch dữ liệu có bị lỗi không</p>\n<pre class=\"language-jsx{8,12,20}\"><code class=\"language-jsx{8,12,20}\">function App() {\n  const [data, setData] = useState({ hits: [] });\n  const [query, setQuery] = useState('redux');\n  const [url, setUrl] = useState(\n    'https://hn.algolia.com/api/v1/search?query=redux',\n  );\n  const [isLoading, setIsLoading] = useState(false);\n  const [isError, setIsError] = useState(false);\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      setIsError(false);\n      setIsLoading(true);\n      \n      try {\n        const result = await axios(url);\n        \n        setData(result.data);\n      } catch (error) {\n        setIsError(true);\n      }\n      \n      setIsLoading(false);\n    };\n    fetchData();\n  }, [url]);\n  return (\n    <Fragment>\n      <input\n        type=\"text\"\n        value={query}\n        onChange={event => setQuery(event.target.value)}\n      />\n      <button\n        type=\"button\"\n        onClick={() =>\n          setUrl(`http://hn.algolia.com/api/v1/search?query=${query}`)\n        }\n      >\n        Search\n      </button>\n      {isError && <div>Something went wrong ...</div>}\n      {isLoading ? (\n        <div>Loading ...</div>\n      ) : (\n        <ul>\n          {data.hits.map(item => (\n            <li key={item.objectID}>\n              <a href={item.url}>{item.title}</a>\n            </li>\n          ))}\n        </ul>\n      )}\n    </Fragment>\n  );\n}</code></pre>\n<h2 id=\"fetch-data-với-form\"><a href=\"#fetch-data-v%E1%BB%9Bi-form\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Fetch data với Form</h2>\n<p>Nãy giờ chúng ta chỉ fetch data với bằng input và button. Khi có nhiều element hơn, chúng ta sẽ đưa nó vào <code class=\"language-text\">form</code> để có thể trigger form submit bằng cách nhấn Enter</p>\n<pre class=\"language-jsx{5,6,7,8,9,10,16,17}\"><code class=\"language-jsx{5,6,7,8,9,10,16,17}\">function App() {\n  ...\n  return (\n    <Fragment>\n      <form\n        onSubmit={event =>\n          setUrl(`http://hn.algolia.com/api/v1/search?query=${query}`)\n          event.preventDefault();\n        }\n      >\n        <input\n          type=\"text\"\n          value={query}\n          onChange={event => setQuery(event.target.value)}\n        />\n        <button type=\"submit\">Search</button>\n      </form>\n      {isError && <div>Something went wrong ...</div>}\n      ...\n    </Fragment>\n  );\n}</code></pre>\n<h2 id=\"custom-hook-để-fetch-data\"><a href=\"#custom-hook-%C4%91%E1%BB%83-fetch-data\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Custom hook để Fetch data</h2>\n<p>Để tái sử dụng được các đoạn code liên quan đến việc fetch data, chúng ta sẽ đưa nó ra thành một custom hook, các giá trị liên quan trực tiếp đến việc fetch data, cụ thể là loading, error chúng ta cũng đưa vào trong custom hook</p>\n<pre class=\"language-js{1,24}\"><code class=\"language-js{1,24}\">const useHackerNewsApi = () => {\n  const [data, setData] = useState({ hits: [] });\n  const [url, setUrl] = useState(\n    'https://hn.algolia.com/api/v1/search?query=redux',\n  );\n  const [isLoading, setIsLoading] = useState(false);\n  const [isError, setIsError] = useState(false);\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      setIsError(false);\n      setIsLoading(true);\n      try {\n        const result = await axios(url);\n        setData(result.data);\n      } catch (error) {\n        setIsError(true);\n      }\n      setIsLoading(false);\n    };\n    \n    fetchData();\n  }, [url]);\n  \n  return [{ data, isLoading, isError }, setUrl];\n}</code></pre>\n<p>Sử dụng bên trong App Component</p>\n<pre class=\"language-jsx{3,8}\"><code class=\"language-jsx{3,8}\">function App() {\n  const [query, setQuery] = useState('redux');\n  const [{ data, isLoading, isError }, doFetch] = useHackerNewsApi();\n  \n  return (\n    <Fragment>\n      <form onSubmit={event => {\n        doFetch(`http://hn.algolia.com/api/v1/search?query=${query}`);\n        event.preventDefault();\n      }}>\n        <input\n          type=\"text\"\n          value={query}\n          onChange={event => setQuery(event.target.value)}\n        />\n        <button type=\"submit\">Search</button>\n      </form>\n      ...\n    </Fragment>\n  );\n}</code></pre>\n<p>Giá trị state lúc khởi tạo của thể đưa vào như một tham số truyền vào cho custom hook luôn</p>\n<pre class=\"language-jsx{5,6}\"><code class=\"language-jsx{5,6}\">import React, { Fragment, useState, useEffect } from 'react';\nimport axios from 'axios';\n\nconst useDataApi = (initialUrl, initialData) => {\n  const [data, setData] = useState(initialData);\n  const [url, setUrl] = useState(initialUrl);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isError, setIsError] = useState(false);\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      setIsError(false);\n      setIsLoading(true);\n      try {\n        const result = await axios(url);\n        setData(result.data);\n      } catch (error) {\n        setIsError(true);\n      }\n      setIsLoading(false);\n    };\n    \n    fetchData();\n  }, [url]);\n  \n  return [{ data, isLoading, isError }, setUrl];\n};\n\nfunction App() {\n  const [query, setQuery] = useState('redux');\n  const [{ data, isLoading, isError }, doFetch] = useDataApi(\n    'https://hn.algolia.com/api/v1/search?query=redux',\n    { hits: [] },\n  );\n  \n  return (\n    <Fragment>\n      <form\n        onSubmit={event => {\n          doFetch(\n            `http://hn.algolia.com/api/v1/search?query=${query}`,\n          );\n          event.preventDefault();\n        }}\n      >\n        <input\n          type=\"text\"\n          value={query}\n          onChange={event => setQuery(event.target.value)}\n        />\n        <button type=\"submit\">Search</button>\n      </form>\n      {isError && <div>Something went wrong ...</div>}\n      {isLoading ? (\n        <div>Loading ...</div>\n      ) : (\n        <ul>\n          {data.hits.map(item => (\n            <li key={item.objectID}>\n              <a href={item.url}>{item.title}</a>\n            </li>\n          ))}\n        </ul>\n      )}\n    </Fragment>\n  );\n}\nexport default App;</code></pre>\n<h2 id=\"reducer-hook\"><a href=\"#reducer-hook\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Reducer hook</h2>\n<p>Với cái custom hook để fetch data như ở trên, chúng ta thấy có 2 state <code class=\"language-text\">isLoading</code>, <code class=\"language-text\">isError</code> quan hệ khá <em>mật thiết</em> với nhau, có thể hợp nhất 2 đứa nó lại bằng <code class=\"language-text\">React.useReducer</code></p>\n<pre class=\"language-jsx{5,9,10,11,16,17,18,19}\"><code class=\"language-jsx{5,9,10,11,16,17,18,19}\">import React, {\n  Fragment,\n  useState,\n  useEffect,\n  useReducer,\n} from 'react';\nimport axios from 'axios';\n\nconst dataFetchReducer = (state, action) => {\n  ...\n};\n\nconst useDataApi = (initialUrl, initialData) => {\n  const [url, setUrl] = useState(initialUrl);\n  \n  const [state, dispatch] = useReducer(dataFetchReducer, {\n    isLoading: false,\n    isError: false,\n    data: initialData,\n  });\n  ...\n};</code></pre>\n<p><code class=\"language-text\">React.useReducer</code> sẽ nhận vào một hàm reducer (công dụng tương tự như hàm reducer của redux ấy) và các giá trị khởi tạo của state, trong trường hợp của chúng ta là <code class=\"language-text\">isLoading</code> và <code class=\"language-text\">isError</code>. Việc này chẳng qua là gom tất cả state liên quan vào một object cho nó <em>tinh tế</em> thôi, thay vì từng state riêng biệt như sử dụng <code class=\"language-text\">useState</code></p>\n<pre class=\"language-js{16,19,21}\"><code class=\"language-js{16,19,21}\">const dataFetchReducer = (state, action) => {\n  ...\n};\n\nconst useDataApi = (initialUrl, initialData) => {\n  const [url, setUrl] = useState(initialUrl);\n  \n  const [state, dispatch] = useReducer(dataFetchReducer, {\n    isLoading: false,\n    isError: false,\n    data: initialData,\n  });\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      dispatch({ type: 'FETCH_INIT' });\n      try {\n        const result = await axios(url);\n        dispatch({ type: 'FETCH_SUCCESS', payload: result.data });\n      } catch (error) {\n        dispatch({ type: 'FETCH_FAILURE' });\n      }\n    };\n    fetchData();\n  }, [url]);\n  \n  ...\n};</code></pre>\n<p>Mình đã bảo rồi, nó sẽ giống như cái reducer trong redux thôi, chúng ta <code class=\"language-text\">dispatch</code> một object gồm <code class=\"language-text\">type</code> và <code class=\"language-text\">payload</code>, căn cứ vào payload mà chúng ta xử lý, cập nhập state</p>\n<p>Cuối cùng chúng ta cập nhập lại giá trị trả về của custom hook nữa</p>\n<pre class=\"language-jsx{12}\"><code class=\"language-jsx{12}\">const useDataApi = (initialUrl, initialData) => {\n  const [url, setUrl] = useState(initialUrl);\n  \n  const [state, dispatch] = useReducer(dataFetchReducer, {\n    isLoading: false,\n    isError: false,\n    data: initialData,\n  });\n  \n  ...\n  \n  return [state, setUrl];\n};</code></pre>\n<p>Cuối cùng, không kém phần quan trọng, phần code thực hiện bên trong <code class=\"language-text\">dataFetchReducer</code></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">dataFetchReducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword control-flow\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span><span class=\"token property-access\">type</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'FETCH_INIT'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token spread operator\">...</span>state<span class=\"token punctuation\">,</span>\n        isLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        isError<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'FETCH_SUCCESS'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token spread operator\">...</span>state<span class=\"token punctuation\">,</span>\n        isLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        isError<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span><span class=\"token property-access\">payload</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'FETCH_FAILURE'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword control-flow\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token spread operator\">...</span>state<span class=\"token punctuation\">,</span>\n        isLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        isError<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword module\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword control-flow\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<h2 id=\"bỏ-qua-việc-fetch-data\"><a href=\"#b%E1%BB%8F-qua-vi%E1%BB%87c-fetch-data\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Bỏ qua việc fetch data</h2>\n<p>Tình huống là khi user chuyển qua một route khác, khi đang fetch data, việc gọi fetch ko cần thiết và có thể bỏ qua</p>\n<pre class=\"language-jsx{11,17,21,29}\"><code class=\"language-jsx{11,17,21,29}\">const useDataApi = (initialUrl, initialData) => {\n  const [url, setUrl] = useState(initialUrl);\n  \n  const [state, dispatch] = useReducer(dataFetchReducer, {\n    isLoading: false,\n    isError: false,\n    data: initialData,\n  });\n  \n  useEffect(() => {\n    let didCancel = false;\n    \n    const fetchData = async () => {\n      dispatch({ type: 'FETCH_INIT' });\n      try {\n        const result = await axios(url);\n        if (!didCancel) {\n          dispatch({ type: 'FETCH_SUCCESS', payload: result.data });\n        }\n      } catch (error) {\n        if (!didCancel) {\n          dispatch({ type: 'FETCH_FAILURE' });\n        }\n      }\n    };\n    \n    fetchData();\n    \n    return () => {\n      didCancel = true;\n    };\n    \n  }, [url]);\n  \n  return [state, setUrl];\n};</code></pre>\n<p>Với việc return một function ở cuối của <code class=\"language-text\">React.useEffect</code>, tên gọi các bạn React đặt là clean up function, nằm trong kiểu effect cần clean up - nói thật mình phát mệt với việc các bạn trong team React cứ thích <em>chế</em> thêm liên tục như vậy.</p>\n<blockquote>\n<p>Nói theo cách của mình đi, nếu bạn return một function ở cuối của <code class=\"language-text\">React.useEffect</code> nó sẽ chạy khi component bị unmount.</p>\n</blockquote>\n<p>Source code có thể tham khảo đầy đủ <a href=\"https://github.com/the-road-to-learn-react/use-data-api/blob/master/src/index.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ở đây</a></p>\n<p><a href=\"https://www.robinwieruch.de/react-hooks-fetch-data\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.robinwieruch.de/react-hooks-fetch-data</a></p>\n","cover_image":"","related":[{"id":"b1851cc1980bb093ae4f97c8d1a1d08d","path":"/su-dung-react-hook-effect/","title":"Sử dụng React Hook Effect","desc":"Bài này mình contribute cho http://vi.reactjs.org về cách sử dụng React Hook Effect"},{"id":"12b2cd38bed043dbfa473bf29abfdeb6","path":"/su-dung-react-lazy-ra-lam-sao/","title":"Sử dụng React.lazy ra làm sao?","desc":"Api mới của React 16.6"},{"id":"c96e777ca9db4c279c1d03ebd80ea3f8","path":"/xu-ly-tap-du-lieu-lon-trong-react/","title":"Xử lý tập dữ liệu lớn trong React","desc":"Tình huống: bạn có một table với rất nhiều dữ liệu đổ vào, nếu bạn thấy component đó render chậm trên màn hình, đó là lúc cần tái cấu trúc"},{"id":"0ad0cd22a45ddb048f8607ccc85df2f1","path":"/rang-buoc-du-lieu-input-voi-htm-l5/","title":"Ràng buộc dữ liệu input với HTML5","desc":"Vì form quá phức tạp, chúng ta cần thêm một bài viết nữa về validation với html"}]}},"context":{}}