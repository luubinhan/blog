{"hash":"e150ec07f11d4d640e5ab6b3dfc7216b64634be9","data":{"post":{"title":"Giới thiệu maximum concurrency của Lambda khi sử dụng với SQS","path":"/2023-01-21-gioi-thieu-max-concurrency-lambda-sqs/","slug":"2023-01-21-gioi-thieu-max-concurrency-lambda-sqs","date":"2023-01-21","timeToRead":1,"tags":[{"id":"aws","title":"aws","path":"/tag/aws/"},{"id":"beginner","title":"beginner","path":"/tag/beginner/"}],"desc":"Khi một SQS gọi lambda function chúng ta có thể quyết định số lượng tối đa concurrency của Lambda","content":"<h2 id=\"giới-thiệu\"><a href=\"#gi%E1%BB%9Bi-thi%E1%BB%87u\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Giới thiệu</h2>\n<p>Với SQS standard, Lambda sẽ <em>poll</em> message trên queue, lúc đầu khởi tạo 5 concurrency, khi message trên SQS tăng lên, Lambda tiếp tục tăng số lượng concurrency lên để đủ đáp ứng, tối đa <em>1000</em></p>\n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2023/01/11/Lambda-processing-standard-SQS-queues.png\"></p>\n<p>Chi phí sẽ đội lên khi số lượng concurrency tăng lên quá nhiều, để ngăn chặn, chúng ta có thể <em>đăng ký</em> số lượng <strong>reserved concurrency</strong> cho từng Lambda function.</p>\n<p>Khi nó chạm đến ngưỡng <strong>reserved concurrency</strong>, message sẽ được đẩy trả về queue, sau đó sẽ tiếp tục retry hoặc gửi vào DLQ (SQS Dead letter queue) nếu đã quá số lần retry cho phép</p>\n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2023/01/11/Lambda-reaching-reserved-concurrency-of-10.-1024x736.png\"></p>\n<p><strong>maximum concurrency</strong> cũng khá giống với reserved concurrency, chỉ khác là nó chỉ hoạt động khi <strong>nơi gọi Lambda là SQS</strong>, khi đạt tới ngưỡng <strong>maximum concurrency</strong> Lambda sẽ ngừng lấy message từ queue, nó sẽ linh động hơn nếu chúng ta cần điều chỉnh giới hạn concurrency theo nơi gọi</p>\n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2023/01/11/Maximum-concurrency-is-set-to-10-for-the-SQS-queue.-1024x604.png\"></p>\n<p>Ngoài việc hạn chế Lambda dùng hết <em>nguồn lực</em> để xử lý message trên queue, chừa <em>sức</em> để xử lý những công việc đến từ các nguồn khác, nó còn tránh được việc message bị đưa về queue và đưa vào DLQ không cần thiết</p>\n<h2 id=\"thiết-đặt\"><a href=\"#thi%E1%BA%BFt-%C4%91%E1%BA%B7t\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thiết đặt</h2>\n<p>Bên trong màn hình cấu hình <strong>Trigger</strong> của Lambda</p>\n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2023/01/11/Configuring-the-maximum-concurrency-for-an-SQS-trigger-in-the-console.-879x1024.png\"></p>\n<p>Nếu sử dụng CLI</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws lambda create-event-source-mapping --function-name my-function <span class=\"token function-name function\">--ScalingConfig</span> <span class=\"token punctuation\">{</span>MaxConcurrency<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">}</span> --event-source-arn arn:aws:sqs:us-east-2:123456789012:my-queue</code></pre></div>\n<p>Nếu sử dụng Cloudformation</p>\n<div class=\"gridsome-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token key atrule\">MaxConcurrencyFunction</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Serverless<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Function\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">Handler</span><span class=\"token punctuation\">:</span> MyLambdaFunction\n      <span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">SQSEventFromMax</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> SQS\n          <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">Queue</span><span class=\"token punctuation\">:</span> MySQSQueueArn\n            <span class=\"token key atrule\">BatchSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">Enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">ScalingConfig</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">MaximumConcurrency</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></code></pre></div>\n","cover_image":"","related":[{"id":"f535766d417badcb135cb627fa5ea2a6","path":"/2020-02-03-huong-dan-cai-dat-eslint-react-javascript-typescript-vscode/","title":"Thiết đặt ESLint khi sử dụng với Javascript, Typescript, React","desc":"Chúng ta bắt đầu với Javascript trước, sau đó sẽ là TypeScript, và React. Mục tiêu là làm đúng, tránh trường hợp cài package không cần thiết hoặc copy/paste các config tới khi nó chạy được thì thôi."},{"id":"9f8cb439930920e69ea8b3a3edab670c","path":"/2023-08-04-tranh-mat-tien-voi-lambda/","title":"Lưu ý khi sử dụng AWS Lambda để tránh mất tiền","desc":"Khi chúng ta sử dụng đúng lúc đúng nơi, những dịch vụ serverless như Lambda sẽ rẻ hơn so với hệ thống bình thường, chúng ta vẫn nghe quảng cáo nhan nhản serverless thì xài nhiêu trả nhiêu, an toàn hơn, khả năng mở rộng và phục hồi tốt hơn cách truyền thống, có thật sự đúng như quảng cáo không?"},{"id":"5b00a35128015178d6efbc7146488897","path":"/2019-12-10-huong-dan-su-dung-v-model-tren-component-long-nhau/","title":"Sử dụng v-model trên component lồng nhau","desc":"Cách viết dùng v-model để tự đồng bộ giá trị khi lồng các component"},{"id":"1e0772ac7b2ea53e3b8d76415505558f","path":"/2018-11-03-gioi-thieu-markdown/","title":"Giới thiệu Markdown","desc":"Markdown vở lòng cho bạn nào chưa biết"}]}},"context":{}}