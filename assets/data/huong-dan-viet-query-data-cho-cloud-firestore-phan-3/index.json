{"hash":"0395a9475e6dcec202a1209b8bd40b74ee081359","data":{"post":{"title":"Hướng dẫn viết query data cho Cloud Firestore - Phần 3","path":"/huong-dan-viet-query-data-cho-cloud-firestore-phan-3/","date":"2018-08-19","timeToRead":2,"tags":[{"id":"firestore","title":"firestore","path":"/tag/firestore/"},{"id":"firebase","title":"firebase","path":"/tag/firebase/"}],"desc":"Series hướng dẫn sử dụng các service Firebase","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid\">Query doucment dựa trên <code class=\"language-text\">auth.uid</code></a></li>\n<li><a href=\"#query-document-d%E1%BB%B1a-tr%C3%AAn-field\">Query document dựa trên field</a></li>\n<li><a href=\"#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query\">Tính toán ràng buộc lúc query</a></li>\n</ul>\n<!-- /TOC -->\n<p>Chúng ta sẽ tiếp tục series về Firestore, nếu 2 bài trước thì chúng ta đã biết cách set security rule, giờ để xem ảnh hưởng của rule này lên lúc query data</p>\n<p>Khi write và read documents, để tiết kiệm thời gian và resource, Cloud Firestore đánh giá các kết quả có thể xảy ra chứ không chạy qua tất cả giá trị. Nếu câu query có document mà user không có quyền truy cập, toàn bộ cái request sẽ fail</p>\n<p>Lưu ý: cách chạy này chỉ áp dụng khi query nhiều documents từ 1 collection. Khi bạn dùng ID để truy xuất đến 1 document sẽ không giống như trên.</p>\n<h1 id=\"query-doucment-dựa-trên-authuid\"><a href=\"#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Query doucment dựa trên <code class=\"language-text\">auth.uid</code></h1>\n<p>Ví dụ bên dưới mô ta cách viết câu query để lấy documents. Hình dung database bao gồm 1 collection của documents <code class=\"language-text\">story</code></p>\n<p>/stories/{storyid}</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  title<span class=\"token operator\">:</span> <span class=\"token string\">\"A Great Story\"</span><span class=\"token punctuation\">,</span>\n  content<span class=\"token operator\">:</span> <span class=\"token string\">\"Once upon a time...\"</span><span class=\"token punctuation\">,</span>\n  author<span class=\"token operator\">:</span> <span class=\"token string\">\"some_auth_id\"</span><span class=\"token punctuation\">,</span>\n  published<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Security rule trên story</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">service</span> cloud.firestore <span class=\"token punctuation\">{</span>\n  match /databases/<span class=\"token punctuation\">{</span>database<span class=\"token punctuation\">}</span>/documents <span class=\"token punctuation\">{</span>\n    match /stories/<span class=\"token punctuation\">{</span>storyid<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n      // Chỉ user đăng nhập có <span class=\"token function\">id</span> <span class=\"token operator\">=</span> author\n      allow read, write: <span class=\"token keyword\">if</span> request.auth.uid <span class=\"token operator\">==</span> resource.data.author<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Câu query nếu sẽ fail vì nó không khớp với security rules ở trên, mặc dù user đăng nhập chính là author của 1 document trong collection</p>\n<pre class=\"language-js\"><code class=\"language-js\">db<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">collection</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stories'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>Trường hợp này chúng ta phải viết như sau</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> user  <span class=\"token operator\">=</span> firebase<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">auth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">currentUser</span><span class=\"token punctuation\">;</span>\ndb<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">collection</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stories'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">where</span><span class=\"token punctuation\">(</span><span class=\"token string\">'author'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'=='</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span><span class=\"token property-access\">uid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<h1 id=\"query-document-dựa-trên-field\"><a href=\"#query-document-d%E1%BB%B1a-tr%C3%AAn-field\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Query document dựa trên field</h1>\n<p>Để hình dung tương quan giữa rule và lúc query, xét ví dụ rule bên dưới, collection <em>stories</em> cho phép bất kỳ user nào truy cập vào <strong>story</strong> documents khi giá trị của field <em>published</em> là <code class=\"language-text\">true</code></p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">service</span> cloud.firestore <span class=\"token punctuation\">{</span>\n  match /databases/<span class=\"token punctuation\">{</span>database<span class=\"token punctuation\">}</span>/documents <span class=\"token punctuation\">{</span>\n    match /stories/<span class=\"token punctuation\">{</span>storyid<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n      allow read: <span class=\"token keyword\">if</span> resource.data.published <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">||</span> request.auth.uid <span class=\"token operator\">==</span> resource.data.author\n\n      allow write: <span class=\"token keyword\">if</span> request.auth.uid <span class=\"token operator\">==</span> resource.data.author<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Để query data ở trên</p>\n<pre class=\"language-js\"><code class=\"language-js\">db<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">collection</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stories'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">where</span><span class=\"token punctuation\">(</span><span class=\"token string\">'published'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'=='</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<h1 id=\"tính-toán-ràng-buộc-lúc-query\"><a href=\"#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Tính toán ràng buộc lúc query</h1>\n<p>Trong biến <code class=\"language-text\">request.query</code> bao gồm <code class=\"language-text\">limit</code>, <code class=\"language-text\">offset</code>, và <code class=\"language-text\">orderBy</code>, ví dụ chúng ta đặt ra rule là không trả về dữ liệu nếu câu query không chứa limit hoặc limit lớn hơn quy định</p>\n<pre class=\"language-shell\"><code class=\"language-shell\">allow list: <span class=\"token keyword\">if</span> request.query.limit <span class=\"token operator\">&lt;</span><span class=\"token operator\">=</span> <span class=\"token number\">10</span></code></pre>\n<p>Một cách đầy đủ hơn, gom các điều kiện về author và publish vào trong hàm <code class=\"language-text\">authorOrPublished()</code> để tránh lập lại</p>\n<pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">service</span> cloud.firestore <span class=\"token punctuation\">{</span>\n  match /databases/<span class=\"token punctuation\">{</span>database<span class=\"token punctuation\">}</span>/documents <span class=\"token punctuation\">{</span>\n    match /stories/<span class=\"token punctuation\">{</span>storyid<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n      // <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token boolean\">true</span><span class=\"token variable\">`</span></span> nếu story đang <span class=\"token string\">'published'</span>\n      // hoặc authored <span class=\"token operator\">=</span> người đang request\n      <span class=\"token keyword\">function</span> <span class=\"token function-name function\">authorOrPublished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin class-name\">return</span> resource.data.published <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">||</span> request.auth.uid <span class=\"token operator\">==</span> resource.data.author<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      allow list: <span class=\"token keyword\">if</span> request.query.limit <span class=\"token operator\">&lt;</span><span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">&amp;&amp;</span>\n                     authorOrPublished<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      allow get: <span class=\"token keyword\">if</span> authorOrPublished<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      \n      allow write: <span class=\"token keyword\">if</span> request.auth.uid <span class=\"token operator\">==</span> resource.data.author<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><a href=\"https://firebase.google.com/docs/firestore/security/rules-query\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Link bài gốc</a></p>\n","cover_image":""}},"context":{}}