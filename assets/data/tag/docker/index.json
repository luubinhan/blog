{"hash":"32a692caa050f4449db6ef3758917749cdab929d","data":{"tag":{"title":"docker","belongsTo":{"edges":[{"node":{"id":"07147b52eef5808a0a63aa97adc0f7b8","title":"Dùng lệnh docker exec để thực thi một lệnh trong Docker Container","path":"/2023-01-14-tuong-tac-voi-docker-container/","date":"2023-01-14","timeToRead":5,"desc":"Tìm hiểu cách tương tác với một docker container đang chạy","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#d%E1%BB%B1ng-m%E1%BB%99t-docker-container-%C4%91%E1%BB%83-th%E1%BB%B1c-h%C3%A0nh\">Dựng một Docker container để thực hành</a></li>\n<li><a href=\"#t%C3%ACm-t%C3%AAn-c%E1%BB%A7a-docker-container\">Tìm tên của Docker container</a></li>\n<li><a href=\"#ch%E1%BA%A1y-shell-trong-docker-container\">Chạy shell trong Docker container</a></li>\n<li><a href=\"#th%E1%BB%B1c-thi-command-trong-docker-container-kh%C3%B4ng-d%C3%B9ng-shell\">Thực thi command trong Docker container không dùng shell</a></li>\n<li><a href=\"#th%E1%BB%B1c-thi-m%E1%BB%99t-command-%E1%BB%9F-m%E1%BB%99t-th%C6%B0-m%E1%BB%A5c-trong-docker-container\">Thực thi một command ở một thư mục trong Docker container</a></li>\n<li><a href=\"#ch%E1%BA%A1y-command-b%E1%BA%B1ng-m%E1%BB%99t-user-kh%C3%A1c-trong-docker-container\">Chạy command bằng một user khác trong Docker container</a></li>\n<li><a href=\"#truy%E1%BB%81n-bi%E1%BA%BFn-m%C3%B4i-tr%C6%B0%E1%BB%9Dng-v%C3%A0o-docker-container\">Truyền biến môi trường vào Docker container</a></li>\n<li><a href=\"#l%E1%BB%97i-th%C6%B0%E1%BB%9Dng-g%E1%BA%B7p\">Lỗi thường gặp</a></li>\n</ul>\n<!-- /TOC -->\n<p>Khi làm việc với Docker chúng ta sẽ có nhu cầu tương tác bên trong container, để debug, inspect, kiểm tra trạng thái hiện của ứng dụng. Để thực thi một lệnh bên trong một container đang chạy, chúng ta sẽ dùng đến câu lệnh <code class=\"language-inline-text\">docker exec</code></p>\n<h2 id=\"dựng-một-docker-container-để-thực-hành\"><a href=\"#d%E1%BB%B1ng-m%E1%BB%99t-docker-container-%C4%91%E1%BB%83-th%E1%BB%B1c-h%C3%A0nh\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Dựng một Docker container để thực hành</h2>\n<p>Chúng ta sẽ dùng <code class=\"language-inline-text\">alpipe</code> image để dựng một container với mục đích thực hành lệnh <code class=\"language-inline-text\">docker exec</code></p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> container-name alpine <span class=\"token function\">watch</span> <span class=\"token string\">\"date >> /var/log/date.log\"</span></code></pre></div>\n<blockquote>\n<p><code class=\"language-inline-text\">-d</code> để chạy chế độ <em>detach</em>, nó sẽ chạy nền và không chiếm lấy terminal</p>\n</blockquote>\n<p><code class=\"language-inline-text\">watch \"date >> /var/log/date.log\"</code> là command mà chúng ta muốn chạy bên trong container, lệnh <code class=\"language-inline-text\">watch</code> sẽ chạy lặp lại sau mỗi 2 giây (thời gian mặc định), trong trường hợp này, câu lệnh <code class=\"language-inline-text\">date >> /var/log/date.log</code> sẽ in thời gian hiện tại vào file <code class=\"language-inline-text\">date.log</code> sau mỗi 2 giây. Cái file nó sẽ như thế này</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Sat Jan 14 01:35:11 UTC 2023\nSat Jan 14 01:35:13 UTC 2023\nSat Jan 14 01:35:15 UTC 2023</code></pre></div>\n<h2 id=\"tìm-tên-của-docker-container\"><a href=\"#t%C3%ACm-t%C3%AAn-c%E1%BB%A7a-docker-container\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Tìm tên của Docker container</h2>\n<p>Trong trường hợp container đang chạy rồi, chúng ta lại không biết tên của nó là gì, chúng ta sẽ liệt kê toàn bộ docker đang chạy</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token function\">ps</span></code></pre></div>\n<p>kết quả trả về</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES\n76aded7112d4   alpine    \"watch 'date >> /var…\"   11 seconds ago   Up 10 seconds             container-name</code></pre></div>\n<p>Dùng container name hoặc container id để nói với <code class=\"language-inline-text\">docker exec</code> container nào sử dụng. Nếu muốn rename </p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token function\">rename</span> container-name new-name</code></pre></div>\n<h2 id=\"chạy-shell-trong-docker-container\"><a href=\"#ch%E1%BA%A1y-shell-trong-docker-container\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Chạy shell trong Docker container</h2>\n<p>Để chạy <em>shell</em> bên trong container, dùng <code class=\"language-inline-text\">docker exec</code> với flag <code class=\"language-inline-text\">-i</code> <code class=\"language-inline-text\">-t</code> (viết gọp lại thành <code class=\"language-inline-text\">-it</code>)</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> container-name <span class=\"token function\">sh</span></code></pre></div>\n<p>Sau câu lệnh này, chúng ta sẽ đứng ở <em>shell</em> terminal bên trong container, để thoát khỏi terminal này, gõ lệnh <code class=\"language-inline-text\">exit</code> và nhấn <code class=\"language-inline-text\">ENTER</code></p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/ <span class=\"token comment\"># exit</span></code></pre></div>\n<p>Nếu không dùng <code class=\"language-inline-text\">shell</code> mà cần đến những tính năng chỉ có trong <code class=\"language-inline-text\">bash</code>, thay <code class=\"language-inline-text\">sh</code> ở câu lệnh trên bằng <code class=\"language-inline-text\">bash</code></p>\n<h2 id=\"thực-thi-command-trong-docker-container-không-dùng-shell\"><a href=\"#th%E1%BB%B1c-thi-command-trong-docker-container-kh%C3%B4ng-d%C3%B9ng-shell\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thực thi command trong Docker container không dùng shell</h2>\n<p>Nếu cần thị thi một lệnh bên trong container, nhưng không cần mở <em>shell</em> để tương tác, gọi <code class=\"language-inline-text\">docker exec</code> không thêm bất kỳ flag nào</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> container-name <span class=\"token function\">tail</span> /var/log/date.log</code></pre></div>\n<p>Nó sẽ chạy lệnh <code class=\"language-inline-text\">tail /var/log/date.log</code> và in ra kết quả, mặc định lệnh <code class=\"language-inline-text\">tail</code> sẽ in ra mười dòng cuối cùng trong file</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Sat Jan 14 01:35:11 UTC 2023\nSat Jan 14 01:35:13 UTC 2023\nSat Jan 14 01:35:15 UTC 2023\nSat Jan 14 01:35:17 UTC 2023\nSat Jan 14 01:35:19 UTC 2023\nSat Jan 14 01:35:21 UTC 2023\nSat Jan 14 01:35:23 UTC 2023\nSat Jan 14 01:35:25 UTC 2023\nSat Jan 14 01:35:27 UTC 2023\nSat Jan 14 01:35:29 UTC 2023</code></pre></div>\n<h2 id=\"thực-thi-một-command-ở-một-thư-mục-trong-docker-container\"><a href=\"#th%E1%BB%B1c-thi-m%E1%BB%99t-command-%E1%BB%9F-m%E1%BB%99t-th%C6%B0-m%E1%BB%A5c-trong-docker-container\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thực thi một command ở một thư mục trong Docker container</h2>\n<p>Để thực thi một lệnh bên trong một thư mục cụ thể, sử dụng flag <code class=\"language-inline-text\">--workdir</code> để chỉ định thư mục</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">--workdir</span> /tmp container-name <span class=\"token builtin class-name\">pwd</span></code></pre></div>\n<p>Câu lệnh trên, chỉ định thư mục <code class=\"language-inline-text\">/tmp</code> là thư mục mà lệnh sẽ đứng ở vị trí đó để thực thi, <code class=\"language-inline-text\">pwd</code> sẽ in ra thư mục hiện tại, kết quả là</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/tmp</code></pre></div>\n<h2 id=\"chạy-command-bằng-một-user-khác-trong-docker-container\"><a href=\"#ch%E1%BA%A1y-command-b%E1%BA%B1ng-m%E1%BB%99t-user-kh%C3%A1c-trong-docker-container\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Chạy command bằng một user khác trong Docker container</h2>\n<p>Sử dụng flag <code class=\"language-inline-text\">--user</code> nếu muốn thực thì bằng một user khác</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">--user</span> guest container-name <span class=\"token function\">whoami</span></code></pre></div>\n<p>Kết quả của câu lệnh <code class=\"language-inline-text\">whoami</code> sẽ trả về user đang gọi lệnh</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">guest</code></pre></div>\n<h2 id=\"truyền-biến-môi-trường-vào-docker-container\"><a href=\"#truy%E1%BB%81n-bi%E1%BA%BFn-m%C3%B4i-tr%C6%B0%E1%BB%9Dng-v%C3%A0o-docker-container\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Truyền biến môi trường vào Docker container</h2>\n<p>Đôi khi chúng ta sẽ có nhu cầu truyền thêm biến môi trường vào trong container để chạy. Flag <code class=\"language-inline-text\">-e</code> sẽ cho phép chỉ định biến môi trường</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TEST</span><span class=\"token operator\">=</span>binhan container-name <span class=\"token function\">env</span></code></pre></div>\n<p>Lệnh này sẽ khai báo một biến môi trường tên <code class=\"language-inline-text\">TEST</code> với giá trị <code class=\"language-inline-text\">binhan</code>. Lệnh <code class=\"language-inline-text\">env</code> sẽ in toàn bộ biến môi trường bên trong container</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nHOSTNAME=2191b2d508e9\nTEST=binhan\nHOME=/root</code></pre></div>\n<p>Nếu cần khai báo thêm biến môi trường thứ 2</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TEST</span><span class=\"token operator\">=</span>binhan <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">ENVIROMENT</span><span class=\"token operator\">=</span>prod container-name <span class=\"token function\">env</span></code></pre></div>\n<p>Nếu mà nhiều biến hơn, chúng ta dùng file <code class=\"language-inline-text\">.env</code>, <code class=\"language-inline-text\">--env-file</code> để truyền file chưa biến môi trường</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> --env-file .env container-name <span class=\"token function\">env</span></code></pre></div>\n<p>Kết quả</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nHOSTNAME=76aded7112d4\nTEST=binhan\nENVIRONMENT=prod\nHOME=/root</code></pre></div>\n<h2 id=\"lỗi-thường-gặp\"><a href=\"#l%E1%BB%97i-th%C6%B0%E1%BB%9Dng-g%E1%BA%B7p\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Lỗi thường gặp</h2>\n<p>Khi sử dụng <code class=\"language-inline-text\">docker exec</code>, có thể chúng ta sẽ gặp một số lỗi như:</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error: No such container: container-name</code></pre></div>\n<p>Kiểm tra lại xem có sai chữ nào không, chạy <code class=\"language-inline-text\">docker ps</code> để kiểm tra lần nữa, tốt nhất là copy tên từ lệnh <code class=\"language-inline-text\">docker ps</code></p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error response from daemon: Container 2a94aae70ea5dc92a12e30b13d0613dd6ca5919174d73e62e29cb0f79db6e4ab is not running</code></pre></div>\n<p>Cái này là do container chưa chạy thôi, chỉ cần <code class=\"language-inline-text\">docker start container-name</code> để dựng nó lên</p>\n<div class=\"gridsome-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error response from daemon: Container container-name is paused, unpause the container before exec</code></pre></div>\n<p>Container đang tạm dừng, khá rõ ràng là chúng ta cần <code class=\"language-inline-text\">docker unpause container-name</code> trước khi muốn làm gì tiếp</p>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-docker-exec-to-run-commands-in-a-docker-container\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How To Use docker exec to Run Commands in a Docker Container</a></p>\n","cover_image":""}}]}}},"context":{}}