{"hash":"aa1b14b28c6a95ff3b4e2423c3c2ee3502c18cfa","data":{"post":{"title":"Sử dụng React-Query để fetch data","path":"/2021-08-15-data-fetching-voi-react-query/","slug":"/2021-08-15-data-fetching-voi-react-query","date":"2021-08-15","timeToRead":4,"tags":[{"id":"react","title":"react","path":"/tag/react/"},{"id":"thu-thuat","title":"thu-thuat","path":"/tag/thu-thuat/"},{"id":"medium","title":"medium","path":"/tag/medium/"}],"desc":"Một giải pháp để chúng ta có thể đơn giản hóa việc lưu trữ dữ liệu từ server và inject vào trong component dễ dàng","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#th%E1%BB%B1c-hi%E1%BB%87n-fetch-v%E1%BB%9Bi-usequery\">Thực hiện fetch với <code class=\"language-inline-text\">useQuery</code></a></li>\n<li><a href=\"#th%E1%BB%B1c-hi%E1%BB%87n-cache\">Thực hiện cache</a></li>\n</ul>\n<!-- /TOC -->\n<p>Đã bao giờ anh em react chúng ta rơi vào cảnh sau: thử tới thử lui bao nhiều là thư viện để quản lý global state, thử bao nhiêu là hook <code class=\"language-inline-text\">useFancyPromise</code>, rồi tự viết những giải pháp riêng, tất cả điều dẫn đến một kết cục: viết cả đống code để xử lý việc fetch data?</p>\n<blockquote>\n<p>Server state và client state cơ bản là khác nhau, vậy tại sao lại trộn chung</p>\n</blockquote>\n<p><strong>Đặc điểm của Server state</strong></p>\n<ol>\n<li><strong>cố định</strong>, ngoài khả năng kiểm soát của client</li>\n<li><strong>bất đồng bộ (async)</strong>, cần fetch để lấy dữ liệu hoặc cập nhập</li>\n<li><strong>chia sẽ</strong>, nhiều người cùng truy xuất đến cùng một tập dữ liệu cũng như thao tác xử lý trên tập dữ liệu này</li>\n</ol>\n<blockquote>\n<p>Đến lúc dừng việc trộn server state vào trong client state</p>\n</blockquote>\n<p><strong>Lợi ích mang lại khi tách việc quản lý server state bằng một công cụ riêng</strong></p>\n<ol>\n<li><strong>cache</strong>, phần khó nhất của lập trình</li>\n<li><strong>Không duplicate</strong> nhiều request</li>\n<li><strong>Cập nhập</strong> ngầm các dữ liệu outdate</li>\n<li><strong>Tối ưu hiệu năng</strong> bằng phân trang, lazy load</li>\n<li>Quản lý <strong>memory và garbage collection</strong> tốt hơn</li>\n</ol>\n<p>Xin giới thiệu với bạn người bạn mới React-query, anh này sẽ cung cấp cho chúng ta</p>\n<ul>\n<li>Một global context để lưu trữ dữ liệu lấy về từ server</li>\n<li>Thiết đặt caching vô cùng đơn giản</li>\n</ul>\n<p>Nếu thích bạn cũng có thể tham khảo thêm <a href=\"https://github.com/vercel/swr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">swr</a> cũng khá cool</p>\n<p>Chúng ta sẽ có các Server side APIs sau</p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// api/product.js</span>\n\n<span class=\"token comment\">// 1. Fetch tất cả products</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProducts</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 2. Fetch một product cụ thể</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProduct</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 3. Thêm một product</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useAddProduct</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 4. Cập nhập một product</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useEditProduct</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 5. Xóa một product</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useDeleteProduct</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"thực-hiện-fetch-với-usequery\"><a href=\"#th%E1%BB%B1c-hi%E1%BB%87n-fetch-v%E1%BB%9Bi-usequery\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thực hiện fetch với <code class=\"language-inline-text\">useQuery</code></h2>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-query'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProducts</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token comment\">// định danh</span>\n<span class=\"gridsome-highlight-code-line\">\t\t<span class=\"token string\">'products'</span><span class=\"token punctuation\">,</span></span>\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/products'</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Sử dụng trong component</p>\n<div class=\"gridsome-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useFetchProducts <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../api/products\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Products</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> products<span class=\"token punctuation\">,</span>\n\t\tisLoading\n\t<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useFetchProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token punctuation\">{</span>\n\t\t\t\tisLoading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token punctuation\">{</span>\n\t\t\t\tproducts <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>\n\t\t\t\t\tproducts<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>product<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t\t\t\t\t</span><span class=\"token punctuation\">{</span>product<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t\t\t\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Việc <code class=\"language-inline-text\">fetch</code> dữ liệu sẽ còn thêm các tính năng như <em>search, phân trang, filter</em>. Có react-query mọi thứ sẽ vô cùng đơn giản</p>\n<div class=\"gridsome-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useFetchProducts <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../api/products\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Products</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// trang hiện tại</span>\n<span class=\"gridsome-highlight-code-line\">\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>page<span class=\"token punctuation\">,</span> setPage<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span>\n\t<span class=\"token comment\">// số item trên trang</span>\n<span class=\"gridsome-highlight-code-line\">\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>limit<span class=\"token punctuation\">,</span> setLimit<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></span>\n\t<span class=\"token comment\">// từ khóa</span>\n<span class=\"gridsome-highlight-code-line\">\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\t\t</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> products<span class=\"token punctuation\">,</span>\n\t\tisLoading\n\t<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useFetchProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n<span class=\"gridsome-highlight-code-line\">\t\tpage<span class=\"token punctuation\">,</span></span><span class=\"gridsome-highlight-code-line\">\t\tlimit<span class=\"token punctuation\">,</span></span><span class=\"gridsome-highlight-code-line\">\t\tname</span>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">\t\t\t</span><span class=\"token punctuation\">{</span>\n\t\t\t\tisLoading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">\t\t\t</span><span class=\"token punctuation\">{</span>\n\t\t\t\tproducts <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>\n\t\t\t\t\tproducts<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>product<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">\t\t\t\t\t\t\t</span><span class=\"token punctuation\">{</span>product<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">\t\t\t\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Chúng ta cần cập nhập lại <code class=\"language-inline-text\">useFetchProducts</code></p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-query'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProducts</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n<span class=\"gridsome-highlight-code-line\">\t\t<span class=\"token punctuation\">[</span><span class=\"token string\">'products'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span>\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gridsome-highlight-code-line\">\t\t\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/products?page=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>page<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;limit=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>limit<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;search=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></span>\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"thực-hiện-cache\"><a href=\"#th%E1%BB%B1c-hi%E1%BB%87n-cache\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thực hiện cache</h2>\n<p>Ví dụ chúng ta muốn đặt cache 10s, chúng ta sẽ sử dụng thiết đặt <code class=\"language-inline-text\">staleTime</code></p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-query'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProducts</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token punctuation\">[</span><span class=\"token string\">'products'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/products?page=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>page<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;limit=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>limit<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;search=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">{</span>\n<span class=\"gridsome-highlight-code-line\">\t\t\t<span class=\"token literal-property property\">staleTime</span><span class=\"token operator\">:</span> <span class=\"token number\">10000</span></span>\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>Cực kỳ đơn giản đúng không!</em></p>\n<p>Tưởng tượng chúng ta có danh sách <em>product</em> hiển thị trên màn hình, click vào một <em>product</em> chúng ta hiển thị pop-up với các thông tin của product</p>\n<p>Để <code class=\"language-inline-text\">fetch</code> một product, chúng ta cũng đồng thời áp dụng cache</p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProduct</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token punctuation\">[</span><span class=\"token string\">'product'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/products/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token literal-property property\">staleTime</span><span class=\"token operator\">:</span> <span class=\"token number\">10000</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Đến phần thú vị nè, <em>nếu các thông tin của từng product hoàn toán giống với thông tin trả về từ danh sách product?</em>, chúng ta có thể áp dụng cache cho từng product trong lúc fetch danh sách product</p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery<span class=\"token punctuation\">,</span> useQueryClient <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-query'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useFetchProducts</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gridsome-highlight-code-line\">\t<span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token punctuation\">[</span><span class=\"token string\">'products'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/products?page=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>page<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;limit=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>limit<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;search=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">{</span>\t\t\t\n\t\t\t<span class=\"token literal-property property\">staleTime</span><span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span>\n<span class=\"gridsome-highlight-code-line\">\t\t\t<span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">products</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>\t\t\t\tproducts<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gridsome-highlight-code-line\">\t\t\t\t\tqueryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span></span>\t\t\t\t\t\t<span class=\"token punctuation\">[</span><span class=\"token string\">'product'</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\tproduct\n\t\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Bằng cách dùng <code class=\"language-inline-text\">useQueryClient().setQuery</code>, chúng ta force cache cho từng <code class=\"language-inline-text\">product.id</code>, để khi <code class=\"language-inline-text\">useFetchProduct</code> chạy nó sẽ có sẵn giá trị cache này và không cần thực hiện gọi API</p>\n<p>Thể hiện chút tình yêu với dự án <code class=\"language-inline-text\">react-query</code> nhé các bạn, <a href=\"https://github.com/tannerlinsley/react-query\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">star ngay không nói nhiều</a></p>\n","cover_image":"","related":[{"id":"b1851cc1980bb093ae4f97c8d1a1d08d","path":"/2019-07-03-huong-dan-su-dung-react-hook-effect/","title":"Sử dụng React Hook Effect","desc":"Bài này mình contribute cho http://vi.reactjs.org về cách sử dụng React Hook Effect"},{"id":"12b2cd38bed043dbfa473bf29abfdeb6","path":"/2018-10-31-gioi-thieu-react-lazy/","title":"Sử dụng React.lazy ra làm sao?","desc":"Api mới của React 16.6"},{"id":"67335fb1f2a382145c69b99fe4e01d34","path":"/2020-03-08-huong-dan-su-dung-react-context-nhu-the-nao-cho-hieu-qua/","title":"Sử dụng React Context như thế nào cho hiệu quả","desc":"Để có thể quản lý được state của ứng dụng một cách tốt nhất, chúng ta cần sự phân chia phù hợp giữa local state (internal state của component) và state cửa ứng dụng đặt trong React Context. Một vài điều muốn chia sẽ để nâng cao khả năng bảo trì và trải nghiệm nếu sử dụng đến context trong React."},{"id":"34e1a6e4e7dac657edca4c9832d737dc","path":"/2018-10-02-huong-dan-su-dung-tabindex-de-di-chuyen/","title":"Sử dụng tabindex","desc":"Mặc định thứ tự tab theo vị trí của DOM rất hữu dụng, tuy nhiên có trường hợp chúng ta sẽ muốn thay đổi thứ tự tab này. Cùng nghiên cứu tabindex để set thứ tự tab"}]}},"context":{}}