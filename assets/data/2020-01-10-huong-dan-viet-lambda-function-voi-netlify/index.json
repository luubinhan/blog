{"hash":"d577dca50e44e17f92870317920528801621135b","data":{"post":{"title":"Viết và Deploy một Lambda Function trên Netlify","path":"/2020-01-10-huong-dan-viet-lambda-function-voi-netlify/","slug":"/2020-01-10-huong-dan-viet-lambda-function-voi-netlify","date":"2020-01-10","timeToRead":4,"tags":[{"id":"netlify","title":"netlify","path":"/tag/netlify/"},{"id":"thu-thuat","title":"thu-thuat","path":"/tag/thu-thuat/"}],"desc":"","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#lambda-function-l%C3%A0-g%C3%AC\">Lambda function là gì?</a></li>\n<li><a href=\"#ch%E1%BA%A1y-c%C3%A1c-function-lambda-%E1%BB%9F-local\">Chạy các function Lambda ở local</a></li>\n<li><a href=\"#deploy-l%C3%AAn-netlify\">Deploy lên Netlify</a></li>\n</ul>\n<!-- /TOC -->\n<h2 id=\"lambda-function-là-gì\"><a href=\"#lambda-function-l%C3%A0-g%C3%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Lambda function là gì?</h2>\n<p>Giải thích về Serverless bạn đọc bài trước có đăng</p>\n<p>Nếu bạn chỉ có một trang blog như thế này, viết bằng Gatsby, không có backend làm sao bạn có thể có được tính năng cho phép user đăng ký nhận bản tin? Ví dụ dùng dịch vụ của MailChimp đi.</p>\n<p>Chúng ta ko thể đưa API key vào trang frontend được, hiển nhiên quá mà! Ai cũng có thể lấy được cái key này thì sao.</p>\n<p>Chúng ta phải thông qua một bên ở giữa, là Lambda function trên Netlify, chúng ta đưa key này cho Netlify, nó sẽ có trách nhiệm bảo mật key này và truyền thông tin tới MailChimp</p>\n<p>Chữ Lambda được <strong>phát minh</strong> đầu tiên bởi Amazon AWS, sau này Netlify cũng dùng luôn tên này, nó là kiểu các <em>hàm trung gian</em>, giúp chúng ta giao tiếp với phía server (vì đây là dạng serverless, chúng ta dùng dịch vụ của nó cung cấp, giống như vua chúa, nếu muốn giao tiếp với anh thì chú cứ thông qua thái dám, họ sẽ truyền tin tới cho anh)</p>\n<p>Cứ dùng trang mặc định của Gatsby</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540301648/sv9k9cv1zdtr4ebqpr09.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Tạo một thư mục bên trong source code, nó sẽ chứa toàn bộ các hàm sẽ giao tiếp với Lambda. Thư mục này đặt đâu cũng được, cứ đặt vào dưới thư mục gốc tên <code class=\"language-inline-text\">functions</code></p>\n<blockquote>\n<p>Mỗi file chỉ chứa 1 function</p>\n</blockquote>\n<p>test.js</p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Mỗi function sẽ nhận 3 parameter </p>\n<ul>\n<li><code class=\"language-inline-text\">event</code>: chứa post data, header</li>\n<li><code class=\"language-inline-text\">context</code>: function này được call ở đâu, thông tin user hiện tại</li>\n<li><code class=\"language-inline-text\">callback</code>: hàm callback thôi, hàm này nhận param đâu tiền là error nếu có lỗi</li>\n</ul>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540301809/exdwztr8lfepei1x88ux.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<h2 id=\"chạy-các-function-lambda-ở-local\"><a href=\"#ch%E1%BA%A1y-c%C3%A1c-function-lambda-%E1%BB%9F-local\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Chạy các function Lambda ở local</h2>\n<p>Cần cài <code class=\"language-inline-text\">netlify-lambda</code> để chạy test dưới local </p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">npm install netlify<span class=\"token operator\">-</span>lambda</code></pre></div>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540301932/y8uyqgcmxa8i9sczpljo.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<div class=\"gridsome-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">netlify-lambda serve &lt;functions_directory></code></pre></div>\n<p><code class=\"language-inline-text\">&lt;functions_directory></code> là thư mục chứa mấy function chúng ta viết</p>\n<p>Thêm đoạn <em>shortcut</em> vào trong package.json để chạy lệnh này</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540302074/xnpujx0smgs1ftul0hr2.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Bước cuối cùng cần làm, tạo file config để báo với Netlify, đây không phải là thư mục chứa source code của chúng ta, đây là thư mục sau khi build. Tạo file <code class=\"language-inline-text\">Netlify.toml</code> trong thư mục gốc</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540302243/gzlbxxtidpi0lukcxmmy.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Sau khi build, file bên trong <code class=\"language-inline-text\">functions</code> sẽ được đưa vào thư mục tên <code class=\"language-inline-text\">lambda</code></p>\n<p>Chạy lại đoạn script <em>shortcut</em> hồi nãy khai báo <code class=\"language-inline-text\">npm run start:lambda</code>, bên dưới hình này đoạn chạy bị lỗi là khi chưa tạo file <code class=\"language-inline-text\">Netlify.toml</code>, chúng ta bắt buộc phải tạo file này trước khi chạy</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540302301/vyr4hwlxacgkhvkvhzdn.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Mở Postman lên gọi test thử</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540302549/jblo4vceh9ylxxipnct8.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Function đầu tiên đã chạy thành công!!!</p>\n<p>Chúng ta truyền thêm một object <code class=\"language-inline-text\">{ \"name\" : \"James\" }</code>, và muốn nhận được một JSON object thay vì là một <code class=\"language-inline-text\">string</code>. Muốn vậy trong phần body chúng ta phải gọi <code class=\"language-inline-text\">JSON.stringify</code></p>\n<div class=\"gridsome-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">statusCode</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Thanks for visiting \"</span> <span class=\"token operator\">+</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// nếu không nhận được name= james</span>\n\n<span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You're not James\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540303047/s7lrt4qmn8svganfbd6s.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Test trên Postman</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540303082/gmlkczsp2hhlasrrko2d.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Trường hợp phát sinh lỗi</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540303092/y1uu9ipfgy0rq6p3mtwr.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<h2 id=\"deploy-lên-netlify\"><a href=\"#deploy-l%C3%AAn-netlify\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Deploy lên Netlify</h2>\n<p>Nãy giờ chúng ta đang chạy các Lambda function ở dưới local bằng lệnh <code class=\"language-inline-text\">serve</code>,  để đưa lên Netlify, chúng ta cần <code class=\"language-inline-text\">build</code> source code trước khi đẩy lên Netlify</p>\n<p>Chúng ta phải setup chạy 2 script, một để build Gatsby, sau đó build mấy functions lambda</p>\n<div class=\"gridsome-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"props\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run build; npm run build:lambda\"</span></code></pre></div>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540315111/hv7omcr0angknnup175q.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Lưu ý: do đang dùng gatsby, nên cần 2 lệnh này, nếu bạn dùng một thằng khác, thì lệnh sẽ khác, tuy cách setup</p>\n<p>Phải cập nhập lại <strong>Netlify.toml</strong>, chúng ta sẽ báo với Netlify: \"Ê, khi nào tao chạy xong <code class=\"language-inline-text\">prop</code>, thì mày deploy nhe\"</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540315122/lytjmmofmjjgixzxycwo.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Sau khi commit lên Github, Netlify sẽ bắt đầu trigger deploy, vào trang chính của Netlify, trong tab <strong>Deployment</strong>, bạn có theo dõi xem nó đang deploy tới đâu rồi</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540315158/kulpc3u2tqftgxijpr6c.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Sau khi deploy thành công, bạn có thể chuyển qua tab <strong>Function</strong>, các function nào đã có sẽ được liệt kê ở đây</p>\n<p><img src=\"https://scotch-res.cloudinary.com/image/upload/dpr_1,w_800,q_auto:good,f_auto/v1540315181/nblkoi0l6shvdvvybtje.png\" alt=\"Viết và Deploy một Lambda Function trên Netlify\"></p>\n<p>Cơ bản là thế thôi, các bạn có thể làm <em>\"mọi thứ\"</em> với function mình viết (miễn là nó có cho), như gửi email, lưu dữ liệu xuống DB, gọi một API</p>\n<p><a href=\"https://scotch.io/tutorials/build-and-deploy-a-serverless-function-to-netlify\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://scotch.io/tutorials/build-and-deploy-a-serverless-function-to-netlify</a></p>\n","cover_image":"","related":[{"id":"ac91020c4cb3f555dd43eb61a87000b8","path":"/2020-10-25-neu-ban-viet-css-co-tam/","title":"Một vài điểm nên nhớ khi viết CSS","desc":"Nếu bạn là người viết CSS có tâm, bạn cần đọc bài này để tránh những lỗi edge case khi viết CSS"},{"id":"98f05c92c93dcf038306c77ca8161149","path":"/2022-06-20-ung-dung-abort-controller/","title":"Một vài ứng dụng của AbortController","desc":""},{"id":"947609e16439d2c38254d1167ee07c91","path":"/2019-11-01-muoi-kinh-nghiem-lam-viec-voi-du-an-vue-lon/","title":"10 kinh nghiệm khi làm việc với các dự án lớn viết bằng Vue.js","desc":"Đây là 10 kinh nghiệm được đúc kết trong lúc làm việc với các bộ source lớn. Vấn đề với tất cả các bộ source lớn là nó rất khó để bảo trì."}]}},"context":{}}