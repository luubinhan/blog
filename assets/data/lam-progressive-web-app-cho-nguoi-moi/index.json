{"hash":"758a6cb1620fd44d4d49859fe95b9857298eb57d","data":{"post":{"title":"Làm Progressive Web App cho người mới","path":"/lam-progressive-web-app-cho-nguoi-moi/","date":"2018-10-16","timeToRead":12,"tags":[{"id":"pwa","title":"pwa","path":"/tag/pwa/"},{"id":"mobile-web-specialist","title":"mobile-web-specialist","path":"/tag/mobile-web-specialist/"}],"desc":"Cùng mình đú trend, dựng một Progressive Web App theo chỉ dẫn của Google","content":"<!-- TOC -->\n<ul>\n<li><a href=\"#gi%e1%bb%9bi-thi%e1%bb%87u\">Giới thiệu</a></li>\n<li><a href=\"#%c4%90%c3%a1nh-gi%c3%a1-b%e1%ba%b1ng-lighthouse\">Đánh giá bằng Lighthouse</a></li>\n<li><a href=\"#th%c3%aam-web-app-manifest\">Thêm web app manifest</a></li>\n<li>\n<p><a href=\"#offline-m%e1%bb%a9c-c%c4%83n-b%e1%ba%a3n\">Offline mức căn bản</a></p>\n<ul>\n<li><a href=\"#%c4%90%c4%83ng-k%c3%bd-service-worker\">Đăng ký service worker</a></li>\n<li><a href=\"#x%e1%bb%ad-l%c3%bd-network-request-b%e1%bb%8b-fail\">Xử lý network request bị fail</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#service-worker-life-cycle\">Service worker life cycle</a></p>\n<ul>\n<li><a href=\"#install\"><code class=\"language-text\">install</code></a></li>\n<li><a href=\"#activate\"><code class=\"language-text\">activate</code></a></li>\n<li><a href=\"#fetch\"><code class=\"language-text\">fetch</code></a></li>\n</ul>\n</li>\n<li><a href=\"#offline-m%e1%bb%a9c-cao-c%e1%ba%a5p-h%c6%a1n-m%e1%bb%99t-ch%c3%bat\">Offline mức cao cấp hơn một chút</a></li>\n<li><a href=\"#th%c3%aam-ph%e1%ba%a7n-c%c3%a0i-%c4%91%e1%ba%b7t\">Thêm phần cài đặt</a></li>\n</ul>\n<!-- /TOC -->\n<h2 id=\"giới-thiệu\"><a href=\"#gi%E1%BB%9Bi-thi%E1%BB%87u\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Giới thiệu</h2>\n<p>Trong lúc lầm Progressive Web App (PWA), chúng ta cần nhớ những điều sau</p>\n<ul>\n<li>Không quan trọng user đang dùng trình duyệt gì</li>\n<li>Hỗ trợ tốt trên nhiều loại thiết bị desktop, mobile, tablet bằng responsive</li>\n<li>Sử dụng service worker để có thể làm việc offline hoặc khi mạng chậm</li>\n<li>Có khả năng cài đặt, sử dụng web app manifest và sự kiện <code class=\"language-text\">beforeinstallprompt</code> để báo user biết có thể install</li>\n</ul>\n<p>Ứng dụng sẽ thực hành là trang dự báo thời tiết</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/95fe6f7fbeee5bb1.png\" alt=\"Ứng dụng thông báo thời tiết.\"></p>\n<p>Chúng ta sẽ tìm hiểu các vấn đề\nLàm sao để tạo và thêm file web app manifest\nCung cấp một trải nghiệm cơ bản khi không có mạng\nLàm sao để làm cho app có thể install\nBạn cần gì để follow tuts này</p>\n<ul>\n<li>Phiên bản mới nhất của Chrome</li>\n<li>Kiến thức căn bản HTML/CSS/Javascript và Chrome DevTools</li>\n<li>Đăng ký <a href=\"https://darksky.net/dev\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Dark Sky API</a> để có 1 API key, dữ liệu thời tiết sẽ do API này cung cấp</li>\n</ul>\n<p>Sao khi đã có 1 API key, chúng ta có thể kiểm tra xem nó có hoạt động hay không bằng cách mở URL này trên trình duyệt</p>\n<pre class=\"language-text\"><code class=\"language-text\">https://api.darksky.net/forecast/DARKSKY_API_KEY/40.7720232,-73.9732319</code></pre>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/archive/master.zip\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Download Source code ví dụ</a></p>\n<p>Vì chúng ta sử dụng Glitch để làm, nên không cần download bộ source về làm gì</p>\n<ol>\n<li>Trước hết mở trang <a href=\"https://glitch.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://glitch.com/</a>, đăng ký 1 tài khoản trên đây</li>\n<li>Chọn <strong>New Project</strong>, sau đó chọn vào <strong>Clone from Git Repo</strong></li>\n<li>Paste đường dẫn <code class=\"language-text\">https://github.com/googlecodelabs/your-first-pwapp.git</code> vào trong hộp thoại popup rồi click OK</li>\n<li>Sau khi repo đã được load về, mở file <code class=\"language-text\">.env</code> lên và điền vào API key đã đăng ký</li>\n<li>Click vào nút <strong>Show</strong> > <strong>In a new window</strong> để xem kết quả, nó sẽ theo cấu trúc là &#x3C;tên project>.glitch.me</li>\n</ol>\n<h2 id=\"đánh-giá-bằng-lighthouse\"><a href=\"#%C4%91%C3%A1nh-gi%C3%A1-b%E1%BA%B1ng-lighthouse\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Đánh giá bằng Lighthouse</h2>\n<p>Trước tiên chúng ta đánh giá sơ bộ trang hiện tại bằng công cụ Lighthouse có sẵn của Chrome. Trên DevTool sẽ có một tab là Audit ở cuối. Nó sẽ cho kết quả đánh giá performance, accessibility, PWA và một số thứ linh tinh khác nữa</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/b112675caafccef0.png\" alt=\"Trước tiên chúng ta đánh giá sơ bộ trang hiện tại bằng công cụ Lighthouse có sẵn của Chrome.\"></p>\n<p>Để chạy đánh giá\n1. Mở DevTool lên, chọn vào <strong>Audits</strong> tab\n2. Dùng tất cả các thiết đặt mặc định nếu ko có ý kiến gì khác\n3. Click <strong>Run audit</strong>, đợi chút nó sẽ cho kết quả</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/af1a64a13725428e.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Chúng ta tập trung fix mấy cái bị báo đỏ</p>\n<h2 id=\"thêm-web-app-manifest\"><a href=\"#th%C3%AAm-web-app-manifest\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thêm web app manifest</h2>\n<p>Nó là một file JSON cho phép chúng ta config một số thứ khi xuất hiện trên thiết bị của user</p>\n<ul>\n<li>Mở cửa sổ mới hay không <code class=\"language-text\">display</code></li>\n<li>Trang mặc định sẽ mở (nếu bạn không muốn là trang index) <code class=\"language-text\">start_url</code></li>\n<li>Icon sẽ hiển thị <code class=\"language-text\">icons</code></li>\n<li>Tên <code class=\"language-text\">short_name</code></li>\n<li>Splash screen <code class=\"language-text\">name</code>, <code class=\"language-text\">icons</code>, <code class=\"language-text\">colors</code></li>\n<li>Mở ngang hay dọc <code class=\"language-text\">orientation</code></li>\n<li>Tạo một file <code class=\"language-text\">public/manifest.json</code> rồi copy nội dung sau vào đó</li>\n</ul>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Weather\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"short_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Weather\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"icons\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-128x128.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"128x128\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-144x144.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"144x144\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-152x152.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"152x152\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-192x192.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"192x192\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-256x256.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"256x256\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/icons/icon-512x512.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"512x512\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"start_url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/index.html\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"display\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"standalone\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"background_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#3E4EB8\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"theme_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#2F3BA2\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<blockquote>\n<p>Trình duyệt Chrome bắt buộc cung cấp ít nhất 2 icon kích thước 192x192px và 512x512px</p>\n</blockquote>\n<p>Bổ sung file này vào trong <code class=\"language-text\">public.index.html</code></p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>manifest<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/manifest.json<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre>\n<p>Trên cửa sổ DevTools, chọn tab <strong>Application</strong> có thể kiểm tra file manifest đã load thành công chưa</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/c462743e1bc26958.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Trình duyệt Safari trên iOS chưa hỗ trợ file manifest này thì có thể bổ sung một số tag sau</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apple-mobile-web-app-capable<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>yes<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apple-mobile-web-app-status-bar-style<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>black<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apple-mobile-web-app-title<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Weather PWA<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apple-touch-icon<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/images/icons/icon-152x152.png<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre>\n<p>Nếu cửa số Audit PWA có thông báo “Does not set an address-bar theme color”, chọn màu thanh address cho phù hợp với màu thương hiệu</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theme-color<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#2F3BA2<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre>\n<h2 id=\"offline-mức-căn-bản\"><a href=\"#offline-m%E1%BB%A9c-c%C4%83n-b%E1%BA%A3n\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Offline mức căn bản</h2>\n<p>Bạn có thể tắt mạng, sau đó mở trang google drive, bạn sẽ thấy vẫn xem được danh sách file, folder trong drive, tất nhiên không mở xem chỉnh sửa mấy file này được, nhưng vẫn đảm bảo có những trải nghiệm “không quá tệ”</p>\n<blockquote>\n<p>Service worker chỉ chạy trên trang web truy cập qua giao thức <code class=\"language-text\">https</code></p>\n</blockquote>\n<p>Những tính năng mà service worker cung cấp, câng nhắc nó như một dạng “nice-to-have”, đừng quá đặt nặng và xem service worker như đấng cứu thế, và cũng đừng chém xuyên lục địa về những tính năng siêu việt của service worker.</p>\n<h3 id=\"đăng-ký-service-worker\"><a href=\"#%C4%91%C4%83ng-k%C3%BD-service-worker\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Đăng ký service worker</h3>\n<p>public/index.html</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'serviceWorker'</span> <span class=\"token keyword\">in</span> <span class=\"token dom variable\">navigator</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token dom variable\">window</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token dom variable\">navigator</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">serviceWorker</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/service-worker.js'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reg</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Service worker registered.'</span><span class=\"token punctuation\">,</span> reg<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Service worker có <code class=\"language-text\">scope</code> (phạm vi hoạt động) theo vị trí file, nghĩa là nếu nhét nó vào file rồi đưa file này trong thư mục con <code class=\"language-text\">scripts</code> nó sẽ không can thiệp được gì những đoạn script nằm ngoài thư mục gốc, nếu đặt ở thư mục gốc, toàn bộ thư mục con sẽ kế thừa được service worker đăng ký ở thư mục gốc</p>\n<p>Cache cái gì? Chúng ta có 1 file là <code class=\"language-text\">public/offline.html</code>, nếu không có mạng, chúng ta sẽ hiển thị file này, cache file này xuống trình duyệt là hợp lý.</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L23\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">FILES_TO_CACHE</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">'/offline.html'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre>\n<p>Tiếp theo, trong sự kiện <code class=\"language-text\">install</code>, chúng ta đưa file này vào danh sách muốn cache</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L29\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\">evt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">waitUntil</span><span class=\"token punctuation\">(</span>\n  caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">open</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CACHE_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ServiceWorker] Pre-caching offline page'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addAll</span><span class=\"token punctuation\">(</span><span class=\"token constant\">FILES_TO_CACHE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre>\n<blockquote>\n<p>Toàn bộ các sự kiện của service worker sẽ được để cập ở phần sau</p>\n</blockquote>\n<p>Mở DevTools, trên tab <strong>Application</strong>, chọn vào service worker để xem những đứa nào đã đăng ký thành công, như hình bên dưới chưa đăng ký gì cả</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/b3aa37b67863fd03.png\" alt=\"Chưa đăng ký service worker nào cả\"></p>\n<p>Với đoạn code đăng ký thành công, chúng ta có danh sách các service worker đã đăng ký được, không chỉ một mà có thể đăng ký nhiều nhé</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/69808e4bf3aee41b.png\" alt=\"Service worker đã đăng ký thành công\"></p>\n<p>Chổ <strong>status</strong>, cái nút tròn xanh xanh cho biết nó đang hoạt động, con số kế bên (34251) sẽ tự động tăng khi update service worker mới</p>\n<p>Trên sự kiện <code class=\"language-text\">activate</code>, chúng ta sẽ thực hiện xóa các cache trước đó</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L36\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\">evt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">waitUntil</span><span class=\"token punctuation\">(</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">keyList</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token known-class-name class-name\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">all</span><span class=\"token punctuation\">(</span>keyList<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token constant\">CACHE_NAME</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[ServiceWorker] Removing old cache'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">delete</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Ấn F5 trên cửa sổ để refresh lại trang, con số bên cạnh status sẽ cho biết đã cập nhập mới</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/1db827d76bc0b359.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<h3 id=\"xử-lý-network-request-bị-fail\"><a href=\"#x%E1%BB%AD-l%C3%BD-network-request-b%E1%BB%8B-fail\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Xử lý network request bị fail</h3>\n<p>Khi gọi <code class=\"language-text\">fetch</code>, service worker sẽ là thằng đứng giữa, nếu có mạng thì gọi lên server, còn không, thì gọi lại giá trị cache trước đó</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/6302ad4ba8460944.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L43\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// thêm xử lý sự kiện fetch</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">mode</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'navigate'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nevt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">respondWith</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">open</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CACHE_NAME</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">'offline.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Nó giống như khái niệm middleware, incepter của axios vậy thôi.</p>\n<blockquote>\n<p>Đưa đoạn <code class=\"language-text\">fetch</code> vào bên trong <code class=\"language-text\">evt.respondWith()</code> sẽ chặn trình duyệt tự ý đi mà không nói với ai, chúng ta sẽ dùng người trung gian để đi nói chuyện với thế giới. Nếu không sử dụng <code class=\"language-text\">evt.respondWith()</code> thì cache trước đó sẽ chẳng có tác dụng vì hết.</p>\n</blockquote>\n<p>Bên dưới của tab <strong>Application</strong>, sẽ cho biết những gì đã được cache lại bên dưới trình duyệt</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/c80a2a2e93c1c3ee.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Để giả lập tình trạng mất mạng, quay lại <strong>Service workers</strong>, click chọn vào checkbox <strong>Offline</strong>. F5 nếu thấy hình em gấu này là coi như thành công.</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/984b34dc2aa667a.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Trên cửa sổ <strong>Service Workers</strong> có một số option khác ngoài <strong>Offline</strong></p>\n<ul>\n<li><strong>Update on reload</strong> luôn luôn load lại service worker khi reload</li>\n<li><strong>Bypass for network</strong> bỏ qua service worker, chạy như không có</li>\n</ul>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/c7ac93904f473a91.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Trên điện thoại có thể dùng chế độ máy bay để tắt mạng và xem trang web nó sẽ ra hình thù thế nào.</p>\n<h2 id=\"service-worker-life-cycle\"><a href=\"#service-worker-life-cycle\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Service worker life cycle</h2>\n<h3 id=\"install\"><a href=\"#install\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a><code class=\"language-text\">install</code></h3>\n<p>Sự kiện này sẽ bắn ra khi worker chạy, và chỉ được tạo ra một lần cho mỗi service worker</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/72ed77b1720512da.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Thông thường nó được sử dụng để cache mọi thứ cho app</p>\n<h3 id=\"activate\"><a href=\"#activate\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a><code class=\"language-text\">activate</code></h3>\n<p>Sau khi <code class=\"language-text\">install</code>, mỗi lần nó khởi động nó sẽ bắn ra sự kiện <code class=\"language-text\">activate</code>, tức là bạn truy cập lại trang web đã vào trước đó. Được dùng để xóa cache trước đó</p>\n<h3 id=\"fetch\"><a href=\"#fetch\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a><code class=\"language-text\">fetch</code></h3>\n<p>Sự kiện này cho phép chúng ta can thiệp vào mọi network request, trước khi ra khỏi <em>nhà</em>, phải trình báo ở đây</p>\n<p>Xem <a href=\"https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">các trường hợp sử dụng ở đây</a></p>\n<h2 id=\"offline-mức-cao-cấp-hơn-một-chút\"><a href=\"#offline-m%E1%BB%A9c-cao-c%E1%BA%A5p-h%C6%A1n-m%E1%BB%99t-ch%C3%BAt\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Offline mức cao cấp hơn một chút</h2>\n<p>Ở trên chúng ta chỉ hiển một trang HTML, thông báo với user là mày đang offline, giờ chúng ta sẽ cho nó thấy cái như là có mạng luôn, giống như khi bạn vào Google Drive lúc ko có mạng đó.</p>\n<p>Quay lại với ví dụ, app chúng ta sử dụng object <code class=\"language-text\">caches</code> bên trong <code class=\"language-text\">window</code>, tuy nhiên không phải browser nào cũng hỗ trợ <code class=\"language-text\">window.caches</code>, chúng ta sẽ update hàm <code class=\"language-text\">getForecastFromCache</code> để rơi vào tình huống đó, vẫn ko ảnh hưởng gì tới app</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/app.js#L164\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/app.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// kiểm tra trước khi thực hiện những việc tiếp theo</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">'caches'</span> <span class=\"token keyword\">in</span> <span class=\"token dom variable\">window</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token dom variable\">window</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">location</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">origin</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/forecast/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>coords<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">match</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error getting data from cache'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Sửa tiếp <a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/app.js#L196\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">updateData()</a>\n<a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/app.js#L200\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/app.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">getForecastFromCache</span><span class=\"token punctuation\">(</span><span class=\"token dom variable\">location</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">geo</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">forecast</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">renderForecast</span><span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">,</span> forecast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>App sẽ gọi lấy dữ liệu từ 1 trong 2 hàm, thông qua cache hoặc <code class=\"language-text\">fetch</code> từ API. Với dữ liệu trả về, chúng ta sẽ xử lý để render lại giao diện nếu cần thiết</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/app.js#L85\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/app.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// nếu dữ liệu này đã mới rồi thì ko cần update làm gì</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastUpdated <span class=\"token operator\">>=</span> data<span class=\"token punctuation\">.</span><span class=\"token property-access\">currently</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">time</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Để App có <em>hình hài</em> lúc mất mạng như lúc có mạng, chúng ta phải cache lại toàn bộ những resource cần thiết khác, ngoài data get từ API</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L23\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">FILES_TO_CACHE</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/index.html'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/scripts/app.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/scripts/install.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/scripts/luxon-1.11.4.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/styles/inline.css'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/add.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/clear-day.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/clear-night.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/cloudy.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/fog.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/hail.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/install.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/partly-cloudy-day.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/partly-cloudy-night.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/rain.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/refresh.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/sleet.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/snow.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/thunderstorm.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/tornado.svg'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'/images/wind.svg'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Vì danh sách mấy file này chúng ta thêm bằng tay, nếu sao này chúng ta thay đổi danh sách file này, phải sửa tay tên <code class=\"language-text\">CACHE_NAME</code>, ví dụ như từ  </p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">CACHE_NAME</span> <span class=\"token operator\">=</span> <span class=\"token string\">'static-cache-v2'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// đổi khi thay đổi danh sách file muốn cache</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CACHE_NAME</span> <span class=\"token operator\">=</span> <span class=\"token string\">'static-cache-v3'</span><span class=\"token punctuation\">;</span></code></pre>\n<blockquote>\n<p>Nếu chỉ sửa mỗi cái tên file cũng phải đổi lại tên cache thì quá tốn công, chưa kể phía user phải down lại toàn bộ resource. <a href=\"https://developers.google.com/web/tools/workbox/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Workbox</a> do google phát triển sẽ giải quyết dùm chúng ta vấn đề này, trong quá trình build, chỉ những file nào đã thay đổi mới cần update phía người dùng</p>\n</blockquote>\n<p>Để đảm bảo trong quá trình <code class=\"language-text\">activate</code>, nó ko vô tình xóa dữ liệu của chúng ta, bên trong hàm bắt sự kiện <code class=\"language-text\">activate</code></p>\n<p>public/service-worker.js</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> <span class=\"token constant\">CACHE_NAME</span> <span class=\"token operator\">&amp;&amp;</span> key <span class=\"token operator\">!==</span> <span class=\"token constant\">DATA_CACHE_NAME</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></code></pre>\n<p>Trong sự kiện <code class=\"language-text\">fetch</code> của service worker, chúng ta cũng thực hiện cập nhập, chúng ta luôn ưu tiên lấy data từ API trước, chỉ khi ko thể gọi được API, chúng ta mới lôi thằng cache ra xài</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/service-worker.js#L42\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/service-worker.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">url</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/forecast/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[Service Worker] Fetch (data)'</span><span class=\"token punctuation\">,</span> evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  evt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">respondWith</span><span class=\"token punctuation\">(</span>\n      caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">open</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DATA_CACHE_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token comment\">// nếu lấy được data từ API, xài luôn và lưu xuống cache một bản</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span><span class=\"token property-access\">status</span> <span class=\"token operator\">===</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                cache<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">put</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">url</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n              <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token comment\">// lỗi network thì đưa về cache</span>\n              <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">match</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nevt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">respondWith</span><span class=\"token punctuation\">(</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">open</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CACHE_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">match</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> response <span class=\"token operator\">||</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">.</span><span class=\"token property-access\">request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Chúng ta bỏ phần điều kiện <code class=\"language-text\">evt.request.mode !== &#39;navigate&#39;</code> vì không chỉ muốn lấy cache cho network request, chúng ta muốn cache mọi thứ từ HTML, CSS, script, image,...</p>\n<p>Giờ gần như chúng ta đã đưa hết những gì cần thiết xuống cache, kiểm tra xem kết quả trên DevTool đã cache thành công chưa nhé</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/731e91776cb6ef18.png\" alt=\"xem kết quả trên DevTool đã cache thành công chưa nhé\"></p>\n<h2 id=\"thêm-phần-cài-đặt\"><a href=\"#th%C3%AAm-ph%E1%BA%A7n-c%C3%A0i-%C4%91%E1%BA%B7t\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Thêm phần cài đặt</h2>\n<p>App thì phải cài đặt được chứ, chúng ta sẽ thêm một nút cho phép user “Cài đặt” vào màn hình điện thoại luôn</p>\n<p><img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/d824e1712e46a1cc.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>User nào <em>thông minh</em> như mình thì sẽ biết cách vào menu của Chrome (hoặc Safari) rồi chọn <strong>Add to Homescreen</strong>, tuy nhiên đâu ai thông minh như mình đâu!</p>\n<p>Thêm file <code class=\"language-text\">install.js</code></p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/index.html#L204\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/index.html</a></p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/scripts/install.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>Điều kiện để user có thể cài đặt được\n<img src=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/img/b921f5583fcddf03.png\" alt=\"Làm Progressive Web App cho người mới\"></p>\n<p>Khi mấy điều kiện này đã có đủ, Chrome sẽ bắn ra sự kiện <code class=\"language-text\">beforeinstallprompt</code>, chúng ta nắm lấy sự kiện này </p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/install.js#L24\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/install.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token dom variable\">window</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'beforeinstallprompt'</span><span class=\"token punctuation\">,</span> saveBeforeInstallPromptEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Bên trong hàm <code class=\"language-text\">saveBeforeInstallPromptEvent</code> chúng ta cho hiện nút cài đặt, lưu tạm cái sự kiện <code class=\"language-text\">beforeinstallprompt</code> để dành xài</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/install.js#L34\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/install.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\">deferredInstallPrompt <span class=\"token operator\">=</span> evt<span class=\"token punctuation\">;</span>\ninstallButton<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">removeAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hidden'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Khi user click vào nút <strong>Install</strong>, chúng ta gọi lại thằng <code class=\"language-text\">beforeinstallprompt.prompt()</code>, rồi ẩn nút này đi</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/install.js#L45\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/install.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\">deferredInstallPrompt<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">prompt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nevt<span class=\"token punctuation\">.</span><span class=\"token property-access\">srcElement</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hidden'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Cũng có thể bắt lấy lựa chọn mà user đã trả lời</p>\n<p><a href=\"https://github.com/googlecodelabs/your-first-pwapp/blob/master/public/scripts/install.js#L47\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public/scripts/install.js</a></p>\n<pre class=\"language-js\"><code class=\"language-js\">deferredInstallPrompt<span class=\"token punctuation\">.</span><span class=\"token property-access\">userChoice</span>\n    <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">choice</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>choice<span class=\"token punctuation\">.</span><span class=\"token property-access\">outcome</span> <span class=\"token operator\">===</span> <span class=\"token string\">'accepted'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User accepted the A2HS prompt'</span><span class=\"token punctuation\">,</span> choice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User dismissed the A2HS prompt'</span><span class=\"token punctuation\">,</span> choice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      deferredInstallPrompt <span class=\"token operator\">=</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Khi thêm vào màn hình chính thành công, hay gọi hoa mỹ là Cài đặt thành công, trình duyệt bắn tiếp một sự kiện khác, chúng ta có thể túm lấy sự kiện này và thông báo gì đó nếu thích</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token dom variable\">window</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'appinstalled'</span><span class=\"token punctuation\">,</span> logAppInstalled<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<blockquote>\n<p>Tips: để CSS riêng cho trường hợp web đang chạy dạng “App” như vậy ta dùng <code class=\"language-text\">display-mode</code></p>\n</blockquote>\n<p>Code đầy đủ nè</p>\n<pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@media</span> all <span class=\"token keyword\">and</span> <span class=\"token punctuation\">(</span><span class=\"token property\">display-mode</span><span class=\"token punctuation\">:</span> standalone<span class=\"token punctuation\">)</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">yellow</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://developers.google.com/web/fundamentals/codelabs/your-first-pwapp/\">Your First Progressive Web App</a></p>\n","cover_image":""}},"context":{}}