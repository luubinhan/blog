{"hash":"4f968092cc5fc7a4ca559e86be209f1fcc1d448f","data":{"post":{"title":"Bảo mật web - Một số kiểu tấn công","path":"/bao-mat-web-mot-so-kieu-tan-cong/","slug":"/2018-11-18-mot-so-van-de-can-quan-tam-de-bao-mat-web","date":"2018-11-18","timeToRead":4,"tags":[{"id":"javascript","title":"javascript","path":"/tag/javascript/"}],"desc":"Tổng quát các vấn đề bạn cần quan tâm để bảo mật ứng dụng web","content":"<!-- TOC -->\n<ul>\n<li>\n<p><a href=\"#c%C3%A1ch-qu%E1%BA%A3n-l%C3%BD-session-hi%E1%BB%87n-t%E1%BA%A1i\">Cách quản lý Session hiện tại</a></p>\n<ul>\n<li><a href=\"#session-qu%E1%BA%A3n-l%C3%BD-b%E1%BB%9Fi-server\">Session quản lý bởi server</a></li>\n<li><a href=\"#session-qu%E1%BA%A3n-l%C3%BD-%E1%BB%9F-client\">Session quản lý ở client</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#m%E1%BB%99t-s%E1%BB%91-ki%E1%BB%83u-t%E1%BA%A5n-c%C3%B4ng\">Một số kiểu tấn công</a></p>\n<ul>\n<li>\n<p><a href=\"#csrf-cross-site-request-forgery\">CSRF (Cross-Site Request Forgery)</a></p>\n<ul>\n<li><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-1-s%E1%BB%AD-d%E1%BB%A5ng-html-token\">Cách ngăn chặn #1: Sử dụng HTML token</a></li>\n<li><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-2-origin-header\">Cách ngăn chặn #2: Origin Header</a></li>\n<li><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-3-d%C3%B9ng-transparent-token\">Cách ngăn chặn #3: dùng transparent token</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#cross-site-scripting-xss\">Cross-Site Scripting (XSS)</a></p>\n<ul>\n<li><a href=\"#store-xss---l%C6%B0u-%C4%91o%E1%BA%A1n-script-%C4%91%C3%B3-l%C3%AAn-tr%C3%AAn-server\">Store XSS - lưu đoạn script đó lên trên server</a></li>\n<li><a href=\"#reflect-xss\">Reflect XSS</a></li>\n<li><a href=\"#dom-based-xss\">DOM-Based XSS</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#c%C3%B4ng-c%E1%BB%A5-ki%E1%BB%83m-tra\">Công cụ kiểm tra</a></li>\n</ul>\n<!-- /TOC -->\n<h2 id=\"cách-quản-lý-session-hiện-tại\"><a href=\"#c%C3%A1ch-qu%E1%BA%A3n-l%C3%BD-session-hi%E1%BB%87n-t%E1%BA%A1i\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cách quản lý Session hiện tại</h2>\n<p>HTTP = stateless</p>\n<ul>\n<li>Tất cả request từ cùng 1 client không liên quan gì với nhau</li>\n<li>Server không có cách nào để lưu tạm giá trị state\nHTTP hỗ trợ gửi đi dữ liệu authentication</li>\n<li>Thông qua <strong>Header.Authorization</strong></li>\n<li>Gửi thông tin kèm theo tất cả request</li>\n<li>Server không can thiệp gì trên từng session</li>\n</ul>\n<h3 id=\"session-quản-lý-bởi-server\"><a href=\"#session-qu%E1%BA%A3n-l%C3%BD-b%E1%BB%9Fi-server\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Session quản lý bởi server</h3>\n<p>Server toàn quyền kiểm soát session, kiểm tra tình trạng active, expire, invalid date, xóa session</p>\n<p>Đại diện cho cách này là dùng Cookie</p>\n<ul>\n<li>Dữ liệu được truyền qua lại giữa server và client</li>\n<li>Hầu hết các trình duyệt đều hỗ trợ, <strong>khó</strong>, nếu sử dụng bên ngoài trình duyệt (ứng dụng điện thoại chẳng hạn)</li>\n<li>Bị tấn công <a href=\"#csrf-cross-site-request-forgery\">CSRF</a></li>\n</ul>\n<p>Theo mặc định các request sẽ không nên gửi kèm thông tin xác thực tài khoản (ví dụ cookie), nếu cần gửi thêm thông tin này bằng thiết đặt <code class=\"language-text\">withCredentials</code> thủ công, phía server đồng thời cũng gửi lại trong response header giá trị <code class=\"language-text\">Access-Control-Allow-Credentials: true</code></p>\n<h3 id=\"session-quản-lý-ở-client\"><a href=\"#session-qu%E1%BA%A3n-l%C3%BD-%E1%BB%9F-client\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Session quản lý ở client</h3>\n<p>Đưa toàn bộ thông tin session xuống phía client\nServer không kiểm soát session nào đang active\nDữ liệu session được gửi đi trên mỗi request</p>\n<p>Đại diện cho kiểu này là dùng Token (JWT đang là phổ biến nhất)</p>\n<ul>\n<li>Dữ liệu session được lưu xuống token, server gửi token này qua HTTP header hoặc body của response</li>\n<li>Ứng dụng tự quản lý chuyện gửi server token này</li>\n<li>Trên mỗi request gửi đi nó không tự chèn token vào, do đó nó không thể tấn công bằng <a href=\"#csrf-cross-site-request-forgery\">CSRF</a></li>\n<li>Mồi ngon của tấn công <a href=\"#cross-site-scripting-xss\">XSS</a></li>\n</ul>\n<h2 id=\"một-số-kiểu-tấn-công\"><a href=\"#m%E1%BB%99t-s%E1%BB%91-ki%E1%BB%83u-t%E1%BA%A5n-c%C3%B4ng\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Một số kiểu tấn công</h2>\n<h3 id=\"csrf-cross-site-request-forgery\"><a href=\"#csrf-cross-site-request-forgery\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>CSRF (Cross-Site Request Forgery)</h3>\n<p>Kiểu tấn công rất phổ biến, nếu thông tin session được gửi qua Cookie. Đại khái là nếu bạn đăng nhập vào facebook.com, sau đó truy cập vào trang web nào đó bị hack rồi, trang bị hack này sẽ gửi một trang có nội dung html bên trong đó nó dùng một thẻ nào đó (như <code class=\"language-text\">&lt;img /&gt;</code>, <code class=\"language-text\">&lt;iframe/&gt;</code>, <code class=\"language-text\">&lt;link/&gt;</code>, <code class=\"language-text\">&lt;bgsound/&gt;</code>, <code class=\"language-text\">&lt;background /&gt;</code>) để gửi một request thay đổi email lên trang facebook.com</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>facebook.com/api/1/destroy<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>facebook.com/api/1/destroy<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>bgsound</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>facebook.com/api/1/destroy<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>background</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>facebook.com/api/1/destroy<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>facebook.com/api/1/destroy<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></code></pre>\n<p><img src=\"https://i.imgur.com/sRrzge5.png\" alt=\"CSRF (Cross-Site Request Forgery)\"></p>\n<h4 id=\"cách-ngăn-chặn-1-sử-dụng-html-token\"><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-1-s%E1%BB%AD-d%E1%BB%A5ng-html-token\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cách ngăn chặn #1: Sử dụng HTML token</h4>\n<p>Dấu token bên trong HTML, ví dụ như nhét nó trong form, server khi nhận được sẽ kiểm tra lại để chắc chắn là token này hợp lệ </p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit.php<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>hidden<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>CSRFToken<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>OWY4NmQwODE4ODRjN2Q2NTlhMmZlYWEwYzU1YWQwMTVhM2JmNGYxYjJiMGI4MjJjZDE1ZDZMGYwMGEwOA==<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>Tuy nhiên cách này sẽ không thích hợp với SPA, vì yêu cầu phía server phải quản lý session của từng user đang login</p>\n<h4 id=\"cách-ngăn-chặn-2-origin-header\"><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-2-origin-header\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cách ngăn chặn #2: Origin Header</h4>\n<p>Với những request như POST/PUT/DELETE, tự động thêm Origin Header để xác thực yêu cầu</p>\n<p><img src=\"https://i.stack.imgur.com/ymk6L.png\" alt=\"Cách ngăn chặn #2: Origin Header\"></p>\n<p><img src=\"https://i.imgur.com/wXzd41T.jpg\" alt=\"Cách ngăn chặn #2: Origin Header\"></p>\n<h4 id=\"cách-ngăn-chặn-3-dùng-transparent-token\"><a href=\"#c%C3%A1ch-ng%C4%83n-ch%E1%BA%B7n-3-d%C3%B9ng-transparent-token\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cách ngăn chặn #3: dùng transparent token</h4>\n<p>So sánh giá trị cookie với giá trị header</p>\n<p>User gửi đi một request, nó nhận được 1 Session Cookie và 1 CSRF Token Cookie.</p>\n<pre class=\"language-text\"><code class=\"language-text\">Set-Cookie: session=...\nSet-Cookie: CSRF-Token=123</code></pre>\n<p>Khi ứng dụng gửi đi một request, javascript sẽ copy cookie và đưa vào header <code class=\"language-text\">X-CSRF-Token</code> chỉ javascript trên trang hiện tại mới truy xuất được thông tin này</p>\n<pre class=\"language-text\"><code class=\"language-text\">Cookie: session=...\nCookie: CSRF-Token=123\nX-CSRF-Token: 123</code></pre>\n<p>Server đơn giản là kiểm tra 2 giá trị <code class=\"language-text\">Cookie: CSRF-Token</code> và <code class=\"language-text\">X-CSRF-Token</code> có khớp không</p>\n<h3 id=\"cross-site-scripting-xss\"><a href=\"#cross-site-scripting-xss\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cross-Site Scripting (XSS)</h3>\n<p>Hacker sẽ tìm cách để chạy javascript trên trang trình duyệt của user, khi user truy cập vào một trang đã bị hack. Hacker sẽ dùng những cách sau</p>\n<h4 id=\"store-xss---lưu-đoạn-script-đó-lên-trên-server\"><a href=\"#store-xss---l%C6%B0u-%C4%91o%E1%BA%A1n-script-%C4%91%C3%B3-l%C3%AAn-tr%C3%AAn-server\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Store XSS - lưu đoạn script đó lên trên server</h4>\n<p><img src=\"https://i.imgur.com/45lHKy2.jpg\" alt=\"Cross-Site Scripting (XSS)\"></p>\n<h4 id=\"reflect-xss\"><a href=\"#reflect-xss\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Reflect XSS</h4>\n<p><img src=\"https://i.imgur.com/dbRVLC5.jpg\" alt=\"Reflect XSS\"></p>\n<h4 id=\"dom-based-xss\"><a href=\"#dom-based-xss\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>DOM-Based XSS</h4>\n<p><img src=\"https://i.imgur.com/29G28Ee.jpg\" alt=\"Reflect XSS\"></p>\n<p>Cách phổ biến để phòng chống</p>\n<ul>\n<li>Filter hết mấy đoạn html nguy hiểm (như &#x3C; >, \" \", &#x26;) trước khi lưu</li>\n<li>Dùng thư viện để escape context-sensitive trước khi output</li>\n</ul>\n<h2 id=\"công-cụ-kiểm-tra\"><a href=\"#c%C3%B4ng-c%E1%BB%A5-ki%E1%BB%83m-tra\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Công cụ kiểm tra</h2>\n<p>Một số trang online để check</p>\n<p><a href=\"https://securityheaders.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://securityheaders.com/</a></p>\n<p><a href=\"https://sitecheck.sucuri.net/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://sitecheck.sucuri.net/</a></p>\n<p><a href=\"https://www.ssllabs.com/ssltest/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.ssllabs.com/ssltest/</a></p>\n<p><a href=\"https://quttera.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://quttera.com/</a></p>\n<p><a href=\"https://detectify.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://detectify.com/</a></p>\n<p><a href=\"https://app.webinspector.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://app.webinspector.com/</a></p>\n<p><a href=\"https://app.upguard.com/webscan\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://app.upguard.com/webscan</a></p>\n<p><a href=\"https://www.youtube.com/watch?v=UFPGOvDrTOk\" target=\"_blank\" rel=\"noopener noreferrer\">Getting Single Page Application Security Right by Philippe De Ryck</a></p>\n","cover_image":"","related":[{"id":"c38039d1560164d2ad876c00b9e16bef","path":"/mot-so-nguon-de-luyen-cong-phu/","title":"Một số nguồn để luyện công phu","desc":"Tổng hợp một số nguồn để đọc và nghiên cứu javascript từ căn bản đến chuyên sâu"},{"id":"c4165c753ae81ff286e7ea6b27b8e2a3","path":"/vai-luu-y-trong-react-de-tranh-cac-van-de-voi-bao-mat/","title":"Vài lưu ý trong React để tránh các vấn đề với bảo mật","desc":"Một vài điểm nhắc nhẹ các bạn khi đang viết React, để tránh bị dính injection"},{"id":"3cbd2588e65e7ca4b1ebac17d5d87485","path":"/mot-so-ung-dung-cua-middleware/","title":"Một số ứng dụng của middleware","desc":"Tiếp theo bài trước về middleware, ứng dụng với các trường hợp thực tế"},{"id":"02a02d68e2737698423d912c23786ac2","path":"/mot-so-cach-viet-su-dung-trong-react/","title":"Một số cách viết sử dụng trong React","desc":"Tổng hợp các cách làm phổ biến trong React"}]}},"context":{}}