<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Hướng dẫn viết điều kiện security rules cho Cloud Firestore - Phần 2 - VuiLapTrinh.com</title><meta name="gridsome:hash" content="bb9d7e5a46c25f220b2fd3c7f9d26cdf170dba2b"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.21"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Tutorials, Blog, Hướng dẫn, chia sẽ kinh nghiệm về Frontend, react, vue, ux, ui"><meta data-vue-tag="ssr" name="desc" content="Series hướng dẫn sử dụng các service Firebase"><link rel="preload" href="/blog/assets/css/0.styles.6e7bce94.css" as="style"><link rel="preload" href="/blog/assets/js/app.dd109642.js" as="script"><link rel="preload" href="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" as="script"><link rel="prefetch" href="/blog/assets/js/page--node-modules-gridsome-app-pages-404-vue.b044eecd.js"><link rel="prefetch" href="/blog/assets/js/page--src-pages-index-vue.bd4a2964.js"><link rel="prefetch" href="/blog/assets/js/page--src-templates-tag-vue.4999789e.js"><link rel="stylesheet" href="/blog/assets/css/0.styles.6e7bce94.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/blog/" class="logo active"><span class="logo__text">
    ← VuiLapTrinh.com
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">Hướng dẫn viết điều kiện security rules cho Cloud Firestore - Phần 2</h1><div class="post-meta">
  Đăng ngày 2018-08-18.
  
    Mất khoảng
    <strong>3 phút</strong> để đọc.
  </div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><!-- TOC -->
<ul>
<li><a href="#x%C3%A1c-th%E1%BB%B1c">Xác thực</a></li>
<li><a href="#ki%E1%BB%83m-tra-d%E1%BB%AF-li%E1%BB%87u">Kiểm tra dữ liệu</a></li>
<li><a href="#truy-c%E1%BA%ADp-%C4%91%E1%BA%BFn-c%C3%A1c-documents-kh%C3%A1c">Truy cập đến các documents khác</a></li>
<li><a href="#h%C3%A0m-t%C3%B9y-bi%E1%BA%BFn">Hàm tùy biến</a></li>
</ul>
<!-- /TOC -->
<h1 id="xác-thực"><a href="#x%C3%A1c-th%E1%BB%B1c" aria-hidden="true"><span class="icon icon-link"></span></a>Xác thực</h1>
<p>Một trong những tình huống phổ biến nhất là cho phép truy cập dữ liệu nếu user đã đăng nhập (còn gọi là xác thực, authentication).</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    // Cho phép user truy cập document
    // trong collection cities nếu đã đăng nhập
    match /cities/<span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read, write: <span class="token keyword">if</span> request.auth.uid <span class="token operator">!=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Hoặc một tình huống phổ biến thứ 2 là cho phép user read và write lên dữ liệu của chính user đó</p>
<pre class="language-shell"><code class="language-shell">services cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    // chỉ cho phép uid khớp với userId trong document.
    // Dùng ký tự đại diện <span class="token punctuation">{</span>userId<span class="token punctuation">}</span> như một biến bên trong câu điều kiện
    match /users/<span class="token punctuation">{</span>userId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read, update, delete: <span class="token keyword">if</span> request.auth.uid <span class="token operator">==</span> userId<span class="token punctuation">;</span>
      allow create: <span class="token keyword">if</span> request.auth.uid <span class="token operator">!=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Nếu đang sử dụng Firebase Authentication, biến <code class="language-text">request.auth</code> sẽ chưa thông tin của user gởi request, xem thêm chi tiết <a href="https://firebase.google.com/docs/reference/rules/rules.firestore.Request#auth" target="_blank" rel="nofollow noopener noreferrer">ở đây.</a></p>
<h1 id="kiểm-tra-dữ-liệu"><a href="#ki%E1%BB%83m-tra-d%E1%BB%AF-li%E1%BB%87u" aria-hidden="true"><span class="icon icon-link"></span></a>Kiểm tra dữ liệu</h1>
<p>Nếu muốn can thiệp việc cho phép hoặc từ chối truy cập theo dữ liệu trong document</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    // cho phép truy cập nếu giá trị của visibility bằng public
    match /cities/<span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read: <span class="token keyword">if</span> resource.data.visibility <span class="token operator">==</span> <span class="token string">'public'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Biến <code class="language-text">resource</code> tương ứng với dữ liệu của document đang request, <code class="language-text">request.data</code> sẽ là toàn bộ các field lưu trong document</p>
<p>Trước khi write dữ liệu xuống, chúng ta sẽ muốn kiểm tra dữ liệu đang có và dữ liệu mới. Nếu chúng ta đang set rule pending write (không write dữ liệu ngay lập tức mà đợi xí), biến <code class="language-text">request.resource</code> lúc này sẽ chứa dữ liệu mới.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    match /cities/<span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow update: <span class="token keyword">if</span> request.resource.data.population <span class="token operator">></span> <span class="token number">0</span>
      <span class="token operator">&amp;&amp;</span> request.resource.data.name <span class="token operator">==</span> resource.data.name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="truy-cập-đến-các-documents-khác"><a href="#truy-c%E1%BA%ADp-%C4%91%E1%BA%BFn-c%C3%A1c-documents-kh%C3%A1c" aria-hidden="true"><span class="icon icon-link"></span></a>Truy cập đến các documents khác</h1>
<p>Sử dụng <code class="language-text">get()</code> và <code class="language-text">exists()</code> chúng ta có thể đánh giá các request với các documents trong database. Cả hai hàm này đều yêu cầu chỉ định đường dẫn đầy đủ, và phải đưa biến theo cú pháp <code class="language-text">$(biến)</code> trong đường dẫn</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    match /cities/<span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      // kiểm tra user hiện tại
      // có tồn tại bên trong collections <span class="token function">users</span>
      // trước khi cho phép tạo thêm city mới
      allow create: <span class="token keyword">if</span> exists<span class="token punctuation">(</span>/databases/<span class="token variable"><span class="token variable">$(</span>database<span class="token variable">)</span></span>/documents/users/<span class="token variable"><span class="token variable">$(</span>request.auth.uid<span class="token variable">)</span></span><span class="token punctuation">)</span>

      // cho phép user xóa city nếu user này là admin
      allow delete: <span class="token keyword">if</span> get<span class="token punctuation">(</span>/databases/<span class="token variable"><span class="token variable">$(</span>database<span class="token variable">)</span></span>/documents/users/<span class="token variable"><span class="token variable">$(</span>request.auth.id<span class="token variable">)</span></span>.data.admin <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Đối với thao tác write, chúng ta có thể sử dụng <code class="language-text">getAfter()</code> để truy cập dữ liệu của document sau khi thực hiện, thằng này cũng giống như <code class="language-text">get</code> phải dùng đường dẫn đầy đủ.</p>
<h1 id="hàm-tùy-biến"><a href="#h%C3%A0m-t%C3%B9y-bi%E1%BA%BFn" aria-hidden="true"><span class="icon icon-link"></span></a>Hàm tùy biến</h1>
<p>Một khi các rule security này trở nên phức tạp, chúng ta sẽ muốn gom các điều kiện này vào trong một hàm để tái sử dụng. Firestore hỗ trợ luôn. Nó sẽ như Javascript, tuy nhiên không hẳn là javascript đâu, nó có một số hạn chế</p>
<ul>
<li>Hàm này luôn chỉ chứa 1 return, không chạy loop, gọi service bên ngoài</li>
<li>Hàm có thể access được các hàm và biến có cùng scope.</li>
<li>Hàm có thể gọi đến hàm khác nhưng không được recurse, tối đa là sâu đến 10 thôi.</li>
</ul>
<p>Ví dụ kết hợp cả 2 điều kiện ở trên thành một hàm</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function-name function">signedInOrPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">return</span> request.auth.uid <span class="token operator">!=</span><span class="token operator">=</span> null <span class="token operator">||</span> resource.data.visibility <span class="token operator">==</span> <span class="token string">'public'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    match /cities/<span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read, write: <span class="token keyword">if</span> signedInOrPublic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    match /users/<span class="token punctuation">{</span>user<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read, write: <span class="token keyword">if</span> signedInOrPublic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><a href="https://firebase.google.com/docs/firestore/security/rules-conditions" target="_blank" rel="nofollow noopener noreferrer">Link bài gốc</a></p>
</div><div class="post__footer"><div class="post-tags"><a href="/blog/tag/firestore/" class="post-tags__link"><span>#</span> firestore
		</a><a href="/blog/tag/firebase/" class="post-tags__link"><span>#</span> firebase
		</a><a href="/blog/tag/security/" class="post-tags__link"><span>#</span> security
		</a></div></div></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-52311ff214b737f722259e901102d6b3'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-52311ff214b737f722259e901102d6b3)' width='180' height='180' xlink:href='data:image/jpeg%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAABwEDBAUGCAAC/8QAMxAAAQMCAwcBBgYDAAAAAAAAAQIDEQAEBRIhBhMxQVFhcQciIzJCgbEIFDORodEWgsH/xAAZAQEBAQEBAQAAAAAAAAAAAAAEAwUGAAH/xAAhEQABBAMAAgMBAAAAAAAAAAABAAIDEQQSISJBBRNRMf/aAAwDAQACEQMRAD8A6Pr1fOalmvLyUAk6AnxS5VROUx4oR%2bvmPXNjZYbhti48DcKUt9LRIJAHsgkaxMmO1ByzxnG8PeQ/a3d5bOIIUVJdUOHMifvWjB8c6aMP2q0CfPbC/TW119SVz9YetmOMLYRfWWH3TaSA4pKVNrWOuhgH6UYtkNrsK2stFvYU65nbjesOpyrbnhPIjuKhPhSwDZw4qw5kU5ph6r%2blpCYFNOLKflV5o1JSXMkDlS5xy1qtDo4mfrWe2/xhWEbJ3t400%2b6oZWyGpkBRiTGoSNJj/tVbEXEN/VMyAC1iPUTaS2xjG3bO3IS3ay2HNJc1lR6xPDx3oa4g0RvVlQcSfhFRLrEF3V0LpSAh10layOMzw7eKl3jqLhxsxLaRw4610MUYiAa1ZMxMosrPugpJJ0nlwiiJ%2bH69eZ28NulfuX7R0LTOhygKB8yKxWLaWoC0BJKpgfL2rdfh8sV3G1F9iBTLNnalGbkFuEADzAVVMpwOO6/xCx4izJaAuiSsT8UV8KKyBznmKih1J714OqIiCa5jVdJsqk4ggL9oRPSqDbty4/w/GnLVzKPyypBkaEif4p5N2RwA/anlPtvsrafAW0tJStChKVA8QR0p4ZqQQil1ilz5Y5nGloXKkcNev908G8iUoSCUiiHtVhFhhdou6wu2O6JyuNg/pzwUCdY5a8JrAXtwErWi3RmIEZwZE9utaccm/QEVzKVZjVrltN4JyJMqFdGemuz7OzmyFjbBGS5eQLm6PMuLAMf6iE/SgBavuMPNOON75wKC0tr4GDPtdqO%2bxm0i8ew0O3O7RfJnett6J4mCnXhH81DNDzGK/i%2b4/wBbZSb7S1xQ2IIVBHWvb2BAIioBcVxMCml3KgYFZQZadtSzAK460hCpkk%2bBTzahmmnXnRA0APmadsj0ol1uE2T6r5SEWgbO9K%2bARGs0H7stto3luczSyS3mEKUJIBI66VrvUnGWlJZwlKsuaHnjmgafCk/f9qwD6y%2b2pbjhKU%2bylWaJ8dabjxmtne0HInolrVcYThj18w5clKzl1KOZ/sVLRtJ%2bQbQ7akpum/01oEA9c3bvULB8WtGbRYuW1vvBOVtTivm48eVUt9Z3dwpKlIbaZIhJQZEdJq7fJxDxxHcdWgxnvtFbZz1ItsQCWMWyWb8hJcn3ZV3Pyz14eK2e9WpUBJoGYHhVpmCQyCtTZBMaHz1oq7DYxvmBh11IeZT7pR%2bZA5eR9vFCyoGs8owm4sz38kK//9k=' /%3e%3c/svg%3e" width="180" data-src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" data-srcset="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" class="author__image g-image g-image--loaded" width="180" alt="Author image"></noscript><!----><p class="author__intro">Hiện tại site đang nâng cấp, các bạn xài tạm</p></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2020.</span><span class="footer__links">luckyluu</span></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Hướng dẫn viết điều kiện security rules cho Cloud Firestore - Phần 2","path":"\u002Fhuong-dan-viet-dieu-kien-security-rules-cho-cloud-firestore-phan-2\u002F","date":"2018-08-18","timeToRead":3,"tags":[{"id":"firestore","title":"firestore","path":"\u002Ftag\u002Ffirestore\u002F"},{"id":"firebase","title":"firebase","path":"\u002Ftag\u002Ffirebase\u002F"},{"id":"security","title":"security","path":"\u002Ftag\u002Fsecurity\u002F"}],"desc":"Series hướng dẫn sử dụng các service Firebase","content":"\u003C!-- TOC --\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"#x%C3%A1c-th%E1%BB%B1c\"\u003EXác thực\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#ki%E1%BB%83m-tra-d%E1%BB%AF-li%E1%BB%87u\"\u003EKiểm tra dữ liệu\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#truy-c%E1%BA%ADp-%C4%91%E1%BA%BFn-c%C3%A1c-documents-kh%C3%A1c\"\u003ETruy cập đến các documents khác\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#h%C3%A0m-t%C3%B9y-bi%E1%BA%BFn\"\u003EHàm tùy biến\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C!-- \u002FTOC --\u003E\n\u003Ch1 id=\"xác-thực\"\u003E\u003Ca href=\"#x%C3%A1c-th%E1%BB%B1c\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EXác thực\u003C\u002Fh1\u003E\n\u003Cp\u003EMột trong những tình huống phổ biến nhất là cho phép truy cập dữ liệu nếu user đã đăng nhập (còn gọi là xác thực, authentication).\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u002F\u002F Cho phép user truy cập document\n    \u002F\u002F trong collection cities nếu đã đăng nhập\n    match \u002Fcities\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Ecity\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read, write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E!=\u003C\u002Fspan\u003E null\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EHoặc một tình huống phổ biến thứ 2 là cho phép user read và write lên dữ liệu của chính user đó\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Eservices cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u002F\u002F chỉ cho phép uid khớp với userId trong document.\n    \u002F\u002F Dùng ký tự đại diện \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003EuserId\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E như một biến bên trong câu điều kiện\n    match \u002Fusers\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003EuserId\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read, update, delete: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E userId\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n      allow create: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E!=\u003C\u002Fspan\u003E null\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENếu đang sử dụng Firebase Authentication, biến \u003Ccode class=\"language-text\"\u003Erequest.auth\u003C\u002Fcode\u003E sẽ chưa thông tin của user gởi request, xem thêm chi tiết \u003Ca href=\"https:\u002F\u002Ffirebase.google.com\u002Fdocs\u002Freference\u002Frules\u002Frules.firestore.Request#auth\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eở đây.\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch1 id=\"kiểm-tra-dữ-liệu\"\u003E\u003Ca href=\"#ki%E1%BB%83m-tra-d%E1%BB%AF-li%E1%BB%87u\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EKiểm tra dữ liệu\u003C\u002Fh1\u003E\n\u003Cp\u003ENếu muốn can thiệp việc cho phép hoặc từ chối truy cập theo dữ liệu trong document\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u002F\u002F cho phép truy cập nếu giá trị của visibility bằng public\n    match \u002Fcities\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Ecity\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E resource.data.visibility \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'public'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EBiến \u003Ccode class=\"language-text\"\u003Eresource\u003C\u002Fcode\u003E tương ứng với dữ liệu của document đang request, \u003Ccode class=\"language-text\"\u003Erequest.data\u003C\u002Fcode\u003E sẽ là toàn bộ các field lưu trong document\u003C\u002Fp\u003E\n\u003Cp\u003ETrước khi write dữ liệu xuống, chúng ta sẽ muốn kiểm tra dữ liệu đang có và dữ liệu mới. Nếu chúng ta đang set rule pending write (không write dữ liệu ngay lập tức mà đợi xí), biến \u003Ccode class=\"language-text\"\u003Erequest.resource\u003C\u002Fcode\u003E lúc này sẽ chứa dữ liệu mới.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    match \u002Fcities\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Ecity\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow update: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.resource.data.population \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E0\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E request.resource.data.name \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.name\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch1 id=\"truy-cập-đến-các-documents-khác\"\u003E\u003Ca href=\"#truy-c%E1%BA%ADp-%C4%91%E1%BA%BFn-c%C3%A1c-documents-kh%C3%A1c\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ETruy cập đến các documents khác\u003C\u002Fh1\u003E\n\u003Cp\u003ESử dụng \u003Ccode class=\"language-text\"\u003Eget()\u003C\u002Fcode\u003E và \u003Ccode class=\"language-text\"\u003Eexists()\u003C\u002Fcode\u003E chúng ta có thể đánh giá các request với các documents trong database. Cả hai hàm này đều yêu cầu chỉ định đường dẫn đầy đủ, và phải đưa biến theo cú pháp \u003Ccode class=\"language-text\"\u003E$(biến)\u003C\u002Fcode\u003E trong đường dẫn\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    match \u002Fcities\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Ecity\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u002F\u002F kiểm tra user hiện tại\n      \u002F\u002F có tồn tại bên trong collections \u003Cspan class=\"token function\"\u003Eusers\u003C\u002Fspan\u003E\n      \u002F\u002F trước khi cho phép tạo thêm city mới\n      allow create: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E exists\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u002Fdatabases\u002F\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u002Fdocuments\u002Fusers\u002F\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Erequest.auth.uid\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\n      \u002F\u002F cho phép user xóa city nếu user này là admin\n      allow delete: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E get\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u002Fdatabases\u002F\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u002Fdocuments\u002Fusers\u002F\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003Erequest.auth.id\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E.data.admin \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EĐối với thao tác write, chúng ta có thể sử dụng \u003Ccode class=\"language-text\"\u003EgetAfter()\u003C\u002Fcode\u003E để truy cập dữ liệu của document sau khi thực hiện, thằng này cũng giống như \u003Ccode class=\"language-text\"\u003Eget\u003C\u002Fcode\u003E phải dùng đường dẫn đầy đủ.\u003C\u002Fp\u003E\n\u003Ch1 id=\"hàm-tùy-biến\"\u003E\u003Ca href=\"#h%C3%A0m-t%C3%B9y-bi%E1%BA%BFn\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EHàm tùy biến\u003C\u002Fh1\u003E\n\u003Cp\u003EMột khi các rule security này trở nên phức tạp, chúng ta sẽ muốn gom các điều kiện này vào trong một hàm để tái sử dụng. Firestore hỗ trợ luôn. Nó sẽ như Javascript, tuy nhiên không hẳn là javascript đâu, nó có một số hạn chế\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EHàm này luôn chỉ chứa 1 return, không chạy loop, gọi service bên ngoài\u003C\u002Fli\u003E\n\u003Cli\u003EHàm có thể access được các hàm và biến có cùng scope.\u003C\u002Fli\u003E\n\u003Cli\u003EHàm có thể gọi đến hàm khác nhưng không được recurse, tối đa là sâu đến 10 thôi.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003EVí dụ kết hợp cả 2 điều kiện ở trên thành một hàm\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function-name function\"\u003EsignedInOrPublic\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token builtin class-name\"\u003Ereturn\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E!=\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E null \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E resource.data.visibility \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'public'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n    match \u002Fcities\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Ecity\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read, write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E signedInOrPublic\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n    match \u002Fusers\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Euser\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read, write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E signedInOrPublic\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Ffirebase.google.com\u002Fdocs\u002Ffirestore\u002Fsecurity\u002Frules-conditions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ELink bài gốc\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n","cover_image":""}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/blog/assets/js/app.dd109642.js" defer></script><script src="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" defer></script>
  </body>
</html>