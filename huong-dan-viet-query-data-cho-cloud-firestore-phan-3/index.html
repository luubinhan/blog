<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Hướng dẫn viết query data cho Cloud Firestore - Phần 3 - VuiLapTrinh.com</title><meta name="gridsome:hash" content="0ea6a5c7ec18fcd2d372c0c225289996c79af9fc"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.21"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Tutorials, Blog, Hướng dẫn, chia sẽ kinh nghiệm về Frontend, react, vue, ux, ui"><meta data-vue-tag="ssr" name="desc" content="Series hướng dẫn sử dụng các service Firebase"><link rel="preload" href="/blog/assets/css/0.styles.d493c61a.css" as="style"><link rel="preload" href="/blog/assets/js/app.f8d91bd5.js" as="script"><link rel="preload" href="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" as="script"><link rel="prefetch" href="/blog/assets/js/page--node-modules-gridsome-app-pages-404-vue.b044eecd.js"><link rel="prefetch" href="/blog/assets/js/page--src-pages-index-vue.bd4a2964.js"><link rel="prefetch" href="/blog/assets/js/page--src-templates-tag-vue.4999789e.js"><link rel="stylesheet" href="/blog/assets/css/0.styles.d493c61a.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/blog/" class="logo active"><span class="logo__text">
    ← VuiLapTrinh.com
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">Hướng dẫn viết query data cho Cloud Firestore - Phần 3</h1><div class="post-meta">
  Đăng ngày 2018-08-19.
  
    Mất khoảng
    <strong>2 phút</strong> để đọc.
  </div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><!-- TOC -->
<ul>
<li><a href="#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid">Query doucment dựa trên <code class="language-text">auth.uid</code></a></li>
<li><a href="#query-document-d%E1%BB%B1a-tr%C3%AAn-field">Query document dựa trên field</a></li>
<li><a href="#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query">Tính toán ràng buộc lúc query</a></li>
</ul>
<!-- /TOC -->
<p>Chúng ta sẽ tiếp tục series về Firestore, nếu 2 bài trước thì chúng ta đã biết cách set security rule, giờ để xem ảnh hưởng của rule này lên lúc query data</p>
<p>Khi write và read documents, để tiết kiệm thời gian và resource, Cloud Firestore đánh giá các kết quả có thể xảy ra chứ không chạy qua tất cả giá trị. Nếu câu query có document mà user không có quyền truy cập, toàn bộ cái request sẽ fail</p>
<p>Lưu ý: cách chạy này chỉ áp dụng khi query nhiều documents từ 1 collection. Khi bạn dùng ID để truy xuất đến 1 document sẽ không giống như trên.</p>
<h1 id="query-doucment-dựa-trên-authuid"><a href="#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid" aria-hidden="true"><span class="icon icon-link"></span></a>Query doucment dựa trên <code class="language-text">auth.uid</code></h1>
<p>Ví dụ bên dưới mô ta cách viết câu query để lấy documents. Hình dung database bao gồm 1 collection của documents <code class="language-text">story</code></p>
<p>/stories/{storyid}</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">"A Great Story"</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token string">"Once upon a time..."</span><span class="token punctuation">,</span>
  author<span class="token operator">:</span> <span class="token string">"some_auth_id"</span><span class="token punctuation">,</span>
  published<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre>
<p>Security rule trên story</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    match /stories/<span class="token punctuation">{</span>storyid<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      // Chỉ user đăng nhập có <span class="token function">id</span> <span class="token operator">=</span> author
      allow read, write: <span class="token keyword">if</span> request.auth.uid <span class="token operator">==</span> resource.data.author<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Câu query nếu sẽ fail vì nó không khớp với security rules ở trên, mặc dù user đăng nhập chính là author của 1 document trong collection</p>
<pre class="language-js"><code class="language-js">db<span class="token punctuation">.</span><span class="token method function property-access">collection</span><span class="token punctuation">(</span><span class="token string">'stories'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Trường hợp này chúng ta phải viết như sau</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> user  <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token method function property-access">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">currentUser</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token method function property-access">collection</span><span class="token punctuation">(</span><span class="token string">'stories'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">where</span><span class="token punctuation">(</span><span class="token string">'author'</span><span class="token punctuation">,</span> <span class="token string">'=='</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="query-document-dựa-trên-field"><a href="#query-document-d%E1%BB%B1a-tr%C3%AAn-field" aria-hidden="true"><span class="icon icon-link"></span></a>Query document dựa trên field</h1>
<p>Để hình dung tương quan giữa rule và lúc query, xét ví dụ rule bên dưới, collection <em>stories</em> cho phép bất kỳ user nào truy cập vào <strong>story</strong> documents khi giá trị của field <em>published</em> là <code class="language-text">true</code></p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    match /stories/<span class="token punctuation">{</span>storyid<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read: <span class="token keyword">if</span> resource.data.published <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">||</span> request.auth.uid <span class="token operator">==</span> resource.data.author

      allow write: <span class="token keyword">if</span> request.auth.uid <span class="token operator">==</span> resource.data.author<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Để query data ở trên</p>
<pre class="language-js"><code class="language-js">db<span class="token punctuation">.</span><span class="token method function property-access">collection</span><span class="token punctuation">(</span><span class="token string">'stories'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">where</span><span class="token punctuation">(</span><span class="token string">'published'</span><span class="token punctuation">,</span> <span class="token string">'=='</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="tính-toán-ràng-buộc-lúc-query"><a href="#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query" aria-hidden="true"><span class="icon icon-link"></span></a>Tính toán ràng buộc lúc query</h1>
<p>Trong biến <code class="language-text">request.query</code> bao gồm <code class="language-text">limit</code>, <code class="language-text">offset</code>, và <code class="language-text">orderBy</code>, ví dụ chúng ta đặt ra rule là không trả về dữ liệu nếu câu query không chứa limit hoặc limit lớn hơn quy định</p>
<pre class="language-shell"><code class="language-shell">allow list: <span class="token keyword">if</span> request.query.limit <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">10</span></code></pre>
<p>Một cách đầy đủ hơn, gom các điều kiện về author và publish vào trong hàm <code class="language-text">authorOrPublished()</code> để tránh lập lại</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">service</span> cloud.firestore <span class="token punctuation">{</span>
  match /databases/<span class="token punctuation">{</span>database<span class="token punctuation">}</span>/documents <span class="token punctuation">{</span>
    match /stories/<span class="token punctuation">{</span>storyid<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      // <span class="token variable"><span class="token variable">`</span><span class="token boolean">true</span><span class="token variable">`</span></span> nếu story đang <span class="token string">'published'</span>
      // hoặc authored <span class="token operator">=</span> người đang request
      <span class="token keyword">function</span> <span class="token function-name function">authorOrPublished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> resource.data.published <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">||</span> request.auth.uid <span class="token operator">==</span> resource.data.author<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      allow list: <span class="token keyword">if</span> request.query.limit <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span>
                     authorOrPublished<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      allow get: <span class="token keyword">if</span> authorOrPublished<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      allow write: <span class="token keyword">if</span> request.auth.uid <span class="token operator">==</span> resource.data.author<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><a href="https://firebase.google.com/docs/firestore/security/rules-query" target="_blank" rel="nofollow noopener noreferrer">Link bài gốc</a></p>
</div><div class="post__footer"><div class="post-tags"><a href="/blog/tag/firestore/" class="post-tags__link"><span>#</span> firestore
		</a><a href="/blog/tag/firebase/" class="post-tags__link"><span>#</span> firebase
		</a></div></div></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-52311ff214b737f722259e901102d6b3'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-52311ff214b737f722259e901102d6b3)' width='180' height='180' xlink:href='data:image/jpeg%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAABwEDBAUGCAAC/8QAMxAAAQMCAwcBBgYDAAAAAAAAAQIDEQAEBRIhBhMxQVFhcQciIzJCgbEIFDORodEWgsH/xAAZAQEBAQEBAQAAAAAAAAAAAAAEAwUGAAH/xAAhEQABBAMAAgMBAAAAAAAAAAABAAIDEQQSISJBBRNRMf/aAAwDAQACEQMRAD8A6Pr1fOalmvLyUAk6AnxS5VROUx4oR%2bvmPXNjZYbhti48DcKUt9LRIJAHsgkaxMmO1ByzxnG8PeQ/a3d5bOIIUVJdUOHMifvWjB8c6aMP2q0CfPbC/TW119SVz9YetmOMLYRfWWH3TaSA4pKVNrWOuhgH6UYtkNrsK2stFvYU65nbjesOpyrbnhPIjuKhPhSwDZw4qw5kU5ph6r%2blpCYFNOLKflV5o1JSXMkDlS5xy1qtDo4mfrWe2/xhWEbJ3t400%2b6oZWyGpkBRiTGoSNJj/tVbEXEN/VMyAC1iPUTaS2xjG3bO3IS3ay2HNJc1lR6xPDx3oa4g0RvVlQcSfhFRLrEF3V0LpSAh10layOMzw7eKl3jqLhxsxLaRw4610MUYiAa1ZMxMosrPugpJJ0nlwiiJ%2bH69eZ28NulfuX7R0LTOhygKB8yKxWLaWoC0BJKpgfL2rdfh8sV3G1F9iBTLNnalGbkFuEADzAVVMpwOO6/xCx4izJaAuiSsT8UV8KKyBznmKih1J714OqIiCa5jVdJsqk4ggL9oRPSqDbty4/w/GnLVzKPyypBkaEif4p5N2RwA/anlPtvsrafAW0tJStChKVA8QR0p4ZqQQil1ilz5Y5nGloXKkcNev908G8iUoSCUiiHtVhFhhdou6wu2O6JyuNg/pzwUCdY5a8JrAXtwErWi3RmIEZwZE9utaccm/QEVzKVZjVrltN4JyJMqFdGemuz7OzmyFjbBGS5eQLm6PMuLAMf6iE/SgBavuMPNOON75wKC0tr4GDPtdqO%2bxm0i8ew0O3O7RfJnett6J4mCnXhH81DNDzGK/i%2b4/wBbZSb7S1xQ2IIVBHWvb2BAIioBcVxMCml3KgYFZQZadtSzAK460hCpkk%2bBTzahmmnXnRA0APmadsj0ol1uE2T6r5SEWgbO9K%2bARGs0H7stto3luczSyS3mEKUJIBI66VrvUnGWlJZwlKsuaHnjmgafCk/f9qwD6y%2b2pbjhKU%2bylWaJ8dabjxmtne0HInolrVcYThj18w5clKzl1KOZ/sVLRtJ%2bQbQ7akpum/01oEA9c3bvULB8WtGbRYuW1vvBOVtTivm48eVUt9Z3dwpKlIbaZIhJQZEdJq7fJxDxxHcdWgxnvtFbZz1ItsQCWMWyWb8hJcn3ZV3Pyz14eK2e9WpUBJoGYHhVpmCQyCtTZBMaHz1oq7DYxvmBh11IeZT7pR%2bZA5eR9vFCyoGs8owm4sz38kK//9k=' /%3e%3c/svg%3e" width="180" data-src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" data-srcset="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/blog/assets/static/author.e6b6009.95c26cbf81b488daf3af4259c9393a66.jpg" class="author__image g-image g-image--loaded" width="180" alt="Author image"></noscript><!----><p class="author__intro">Hiện tại site đang nâng cấp, các bạn xài tạm</p></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2020.</span><span class="footer__links">luckyluu</span></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Hướng dẫn viết query data cho Cloud Firestore - Phần 3","path":"\u002Fhuong-dan-viet-query-data-cho-cloud-firestore-phan-3\u002F","date":"2018-08-19","timeToRead":2,"tags":[{"id":"firestore","title":"firestore","path":"\u002Ftag\u002Ffirestore\u002F"},{"id":"firebase","title":"firebase","path":"\u002Ftag\u002Ffirebase\u002F"}],"desc":"Series hướng dẫn sử dụng các service Firebase","content":"\u003C!-- TOC --\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid\"\u003EQuery doucment dựa trên \u003Ccode class=\"language-text\"\u003Eauth.uid\u003C\u002Fcode\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#query-document-d%E1%BB%B1a-tr%C3%AAn-field\"\u003EQuery document dựa trên field\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query\"\u003ETính toán ràng buộc lúc query\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C!-- \u002FTOC --\u003E\n\u003Cp\u003EChúng ta sẽ tiếp tục series về Firestore, nếu 2 bài trước thì chúng ta đã biết cách set security rule, giờ để xem ảnh hưởng của rule này lên lúc query data\u003C\u002Fp\u003E\n\u003Cp\u003EKhi write và read documents, để tiết kiệm thời gian và resource, Cloud Firestore đánh giá các kết quả có thể xảy ra chứ không chạy qua tất cả giá trị. Nếu câu query có document mà user không có quyền truy cập, toàn bộ cái request sẽ fail\u003C\u002Fp\u003E\n\u003Cp\u003ELưu ý: cách chạy này chỉ áp dụng khi query nhiều documents từ 1 collection. Khi bạn dùng ID để truy xuất đến 1 document sẽ không giống như trên.\u003C\u002Fp\u003E\n\u003Ch1 id=\"query-doucment-dựa-trên-authuid\"\u003E\u003Ca href=\"#query-doucment-d%E1%BB%B1a-tr%C3%AAn-authuid\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EQuery doucment dựa trên \u003Ccode class=\"language-text\"\u003Eauth.uid\u003C\u002Fcode\u003E\u003C\u002Fh1\u003E\n\u003Cp\u003EVí dụ bên dưới mô ta cách viết câu query để lấy documents. Hình dung database bao gồm 1 collection của documents \u003Ccode class=\"language-text\"\u003Estory\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u002Fstories\u002F{storyid}\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  title\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E\"A Great Story\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  content\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E\"Once upon a time...\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  author\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E\"some_auth_id\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  published\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Efalse\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ESecurity rule trên story\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    match \u002Fstories\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Estoryid\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u002F\u002F Chỉ user đăng nhập có \u003Cspan class=\"token function\"\u003Eid\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E author\n      allow read, write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.author\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ECâu query nếu sẽ fail vì nó không khớp với security rules ở trên, mặc dù user đăng nhập chính là author của 1 document trong collection\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode class=\"language-js\"\u003Edb\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Ecollection\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'stories'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ETrường hợp này chúng ta phải viết như sau\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"token keyword\"\u003Evar\u003C\u002Fspan\u003E user  \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E firebase\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Eauth\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token property-access\"\u003EcurrentUser\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\ndb\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Ecollection\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'stories'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Ewhere\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'author'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'=='\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E user\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token property-access\"\u003Euid\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch1 id=\"query-document-dựa-trên-field\"\u003E\u003Ca href=\"#query-document-d%E1%BB%B1a-tr%C3%AAn-field\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EQuery document dựa trên field\u003C\u002Fh1\u003E\n\u003Cp\u003EĐể hình dung tương quan giữa rule và lúc query, xét ví dụ rule bên dưới, collection \u003Cem\u003Estories\u003C\u002Fem\u003E cho phép bất kỳ user nào truy cập vào \u003Cstrong\u003Estory\u003C\u002Fstrong\u003E documents khi giá trị của field \u003Cem\u003Epublished\u003C\u002Fem\u003E là \u003Ccode class=\"language-text\"\u003Etrue\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    match \u002Fstories\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Estoryid\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      allow read: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E resource.data.published \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.author\n\n      allow write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.author\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EĐể query data ở trên\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode class=\"language-js\"\u003Edb\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Ecollection\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'stories'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Ewhere\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'published'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'=='\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token method function property-access\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch1 id=\"tính-toán-ràng-buộc-lúc-query\"\u003E\u003Ca href=\"#t%C3%ADnh-to%C3%A1n-r%C3%A0ng-bu%E1%BB%99c-l%C3%BAc-query\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ETính toán ràng buộc lúc query\u003C\u002Fh1\u003E\n\u003Cp\u003ETrong biến \u003Ccode class=\"language-text\"\u003Erequest.query\u003C\u002Fcode\u003E bao gồm \u003Ccode class=\"language-text\"\u003Elimit\u003C\u002Fcode\u003E, \u003Ccode class=\"language-text\"\u003Eoffset\u003C\u002Fcode\u003E, và \u003Ccode class=\"language-text\"\u003EorderBy\u003C\u002Fcode\u003E, ví dụ chúng ta đặt ra rule là không trả về dữ liệu nếu câu query không chứa limit hoặc limit lớn hơn quy định\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Eallow list: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.query.limit \u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E10\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EMột cách đầy đủ hơn, gom các điều kiện về author và publish vào trong hàm \u003Ccode class=\"language-text\"\u003EauthorOrPublished()\u003C\u002Fcode\u003E để tránh lập lại\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Eservice\u003C\u002Fspan\u003E cloud.firestore \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  match \u002Fdatabases\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Edatabase\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u002Fdocuments \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    match \u002Fstories\u002F\u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003Estoryid\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u002F\u002F \u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E`\u003C\u002Fspan\u003E\u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token variable\"\u003E`\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E nếu story đang \u003Cspan class=\"token string\"\u003E'published'\u003C\u002Fspan\u003E\n      \u002F\u002F hoặc authored \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E người đang request\n      \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function-name function\"\u003EauthorOrPublished\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token builtin class-name\"\u003Ereturn\u003C\u002Fspan\u003E resource.data.published \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.author\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n      allow list: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.query.limit \u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E10\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E\n                     authorOrPublished\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\n      allow get: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E authorOrPublished\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n      \n      allow write: \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E request.auth.uid \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E resource.data.author\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Ffirebase.google.com\u002Fdocs\u002Ffirestore\u002Fsecurity\u002Frules-query\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ELink bài gốc\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n","cover_image":""}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/blog/assets/js/app.f8d91bd5.js" defer></script><script src="/blog/assets/js/page--src-templates-post-vue.980fbd47.js" defer></script>
  </body>
</html>